-- CMS-005: Create blog_posts table and RLS policies
-- Purpose: Manage blog posts with SEO optimization and analytics

CREATE TABLE IF NOT EXISTS public.blog_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  summary TEXT NOT NULL,
  content TEXT NOT NULL,
  thumbnail TEXT,
  category_id UUID,
  tags TEXT[] DEFAULT '{}',
  reading_time INTEGER DEFAULT 0,
  views INTEGER DEFAULT 0,
  featured BOOLEAN DEFAULT false,
  seo_title TEXT,
  seo_description TEXT,
  published BOOLEAN DEFAULT false,
  published_at TIMESTAMPTZ,
  author_id UUID REFERENCES public.admins(user_id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes
CREATE UNIQUE INDEX idx_blog_slug ON public.blog_posts(slug);
CREATE INDEX idx_blog_published ON public.blog_posts(published);
CREATE INDEX idx_blog_author ON public.blog_posts(author_id);
CREATE INDEX idx_blog_category ON public.blog_posts(category_id);
CREATE INDEX idx_blog_published_at ON public.blog_posts(published_at DESC);
CREATE INDEX idx_blog_featured ON public.blog_posts(featured);

-- Enable RLS
ALTER TABLE public.blog_posts ENABLE ROW LEVEL SECURITY;

-- RLS Policies
-- SELECT: 공개된 항목은 모든 사용자 조회 가능, 비공개는 관리자만
CREATE POLICY "Public can view published blog posts"
  ON public.blog_posts
  FOR SELECT
  USING (published = true OR auth.uid() IN (SELECT user_id FROM public.admins));

-- INSERT: 관리자만 가능
CREATE POLICY "Admins can create blog posts"
  ON public.blog_posts
  FOR INSERT
  WITH CHECK (
    auth.uid() IN (SELECT user_id FROM public.admins)
  );

-- UPDATE: 관리자만 가능
CREATE POLICY "Admins can update blog posts"
  ON public.blog_posts
  FOR UPDATE
  USING (
    auth.uid() IN (SELECT user_id FROM public.admins)
  );

-- DELETE: Admin 이상만 가능 (Editor 제외)
CREATE POLICY "Admins can delete blog posts"
  ON public.blog_posts
  FOR DELETE
  USING (
    auth.uid() IN (
      SELECT user_id FROM public.admins WHERE role IN ('super_admin', 'admin')
    )
  );

-- Update updated_at trigger
CREATE OR REPLACE FUNCTION update_blog_posts_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER blog_posts_updated_at
  BEFORE UPDATE ON public.blog_posts
  FOR EACH ROW
  EXECUTE FUNCTION update_blog_posts_updated_at();

-- Auto-set published_at trigger
CREATE OR REPLACE FUNCTION set_blog_published_at()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.published = true AND OLD.published = false THEN
    NEW.published_at = NOW();
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER blog_posts_set_published_at
  BEFORE UPDATE ON public.blog_posts
  FOR EACH ROW
  EXECUTE FUNCTION set_blog_published_at();

-- Comments
COMMENT ON TABLE public.blog_posts IS 'Blog posts with SEO optimization and analytics';
COMMENT ON COLUMN public.blog_posts.content IS 'Markdown content';
COMMENT ON COLUMN public.blog_posts.reading_time IS 'Estimated reading time in minutes';
COMMENT ON COLUMN public.blog_posts.views IS 'View count for analytics';
COMMENT ON COLUMN public.blog_posts.featured IS 'Pin to top of blog page';
COMMENT ON COLUMN public.blog_posts.published_at IS 'Auto-set when published is set to true';

-- Grant permissions
GRANT SELECT ON public.blog_posts TO anon, authenticated;
GRANT INSERT, UPDATE, DELETE ON public.blog_posts TO authenticated;
