openapi: 3.0.3
info:
  title: IDEA on Action API
  description: |
    IDEA on Action 플랫폼의 공식 API입니다.

    이 API는 Minu 서비스(Find, Frame, Build, Keep)와의 연동을 위한
    OAuth 2.0 + PKCE 인증, 사용자 프로필 조회, 구독 상태 관리를 제공합니다.

    ## 주요 기능
    - **OAuth 2.0 + PKCE**: Authorization Code Flow 기반 안전한 인증
    - **사용자 API**: 프로필 및 구독 정보 조회
    - **구독 API**: 플랜 기능, 사용량, 제한 관리
    - **Health Check**: 서비스 상태 모니터링

    ## 인증 방식
    1. OAuth 2.0 Authorization Code Flow (PKCE 필수)
    2. Bearer Token (JWT)

    ## 베이스 URL
    - Production: `https://zykjdneewbzyazfukzyg.supabase.co/functions/v1`
    - Staging: `https://staging.ideaonaction.ai/api/v1`
    - Development: `https://dev.ideaonaction.ai/api/v1`

    ## 에러 응답
    모든 에러는 RFC 7807 Problem Details 형식을 따릅니다.

  version: 1.0.0
  contact:
    name: IDEA on Action 기술 팀
    email: sinclairseo@gmail.com
    url: https://www.ideaonaction.ai
  license:
    name: Proprietary
    url: https://www.ideaonaction.ai/terms

servers:
  - url: https://zykjdneewbzyazfukzyg.supabase.co/functions/v1
    description: Production 환경
  - url: https://staging.ideaonaction.ai/api/v1
    description: Staging 환경 (예정)
  - url: https://dev.ideaonaction.ai/api/v1
    description: Development 환경 (예정)

tags:
  - name: OAuth
    description: OAuth 2.0 인증 엔드포인트
  - name: User
    description: 사용자 정보 API
  - name: Subscription
    description: 구독 관리 API
  - name: Health
    description: 서비스 상태 API

paths:
  /oauth-authorize:
    get:
      tags:
        - OAuth
      summary: Authorization Code 발급
      description: |
        OAuth 2.0 Authorization Code Flow의 첫 단계입니다.
        사용자 인증 및 동의 후 Authorization Code를 발급합니다.
        PKCE(Proof Key for Code Exchange) 방식을 필수로 사용합니다.
      operationId: authorizeOAuth
      parameters:
        - name: response_type
          in: query
          required: true
          description: 응답 타입 (고정값)
          schema:
            type: string
            enum: [code]
        - name: client_id
          in: query
          required: true
          description: OAuth 클라이언트 ID
          schema:
            type: string
            example: minu-find-prod
        - name: redirect_uri
          in: query
          required: true
          description: 인증 완료 후 리다이렉트할 URL (사전 등록 필요)
          schema:
            type: string
            format: uri
            example: https://find.minu.best/auth/callback
        - name: scope
          in: query
          required: true
          description: 요청할 권한 범위 (공백으로 구분)
          schema:
            type: string
            example: profile subscription:read
        - name: state
          in: query
          required: false
          description: CSRF 방지용 랜덤 문자열
          schema:
            type: string
        - name: code_challenge
          in: query
          required: true
          description: PKCE code_verifier의 SHA256 해시 (Base64URL 인코딩)
          schema:
            type: string
        - name: code_challenge_method
          in: query
          required: true
          description: PKCE 챌린지 방법 (S256 필수)
          schema:
            type: string
            enum: [S256]
      responses:
        '302':
          description: 인증 성공 - 클라이언트로 리다이렉트
          headers:
            Location:
              description: redirect_uri?code={code}&state={state}
              schema:
                type: string
                format: uri
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 인증 필요 - 로그인 페이지로 리다이렉트
          headers:
            Location:
              schema:
                type: string
                format: uri

  /oauth-token:
    post:
      tags:
        - OAuth
      summary: Access Token 발급
      description: |
        Authorization Code 또는 Refresh Token을 사용하여 Access Token을 발급합니다.

        **Grant Types**:
        - `authorization_code`: Authorization Code를 Access Token으로 교환
        - `refresh_token`: Refresh Token으로 새 Access Token 발급
      operationId: tokenOAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AuthorizationCodeGrantRequest'
                - $ref: '#/components/schemas/RefreshTokenGrantRequest'
            examples:
              authorization_code:
                summary: Authorization Code Grant
                value:
                  grant_type: authorization_code
                  code: ac_abc123...
                  redirect_uri: https://find.minu.best/auth/callback
                  client_id: minu-find-prod
                  code_verifier: dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
              refresh_token:
                summary: Refresh Token Grant
                value:
                  grant_type: refresh_token
                  refresh_token: rt_def456...
                  client_id: minu-find-prod
      responses:
        '200':
          description: 토큰 발급 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /oauth-revoke:
    post:
      tags:
        - OAuth
      summary: Token 폐기
      description: |
        Access Token 또는 Refresh Token을 무효화합니다.
        RFC 7009 표준을 따르며, 항상 200 OK를 반환합니다.
      operationId: revokeOAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevokeRequest'
      responses:
        '200':
          description: 폐기 성공 (토큰이 없어도 200 반환)

  /user-api:
    get:
      tags:
        - User
      summary: 사용자 프로필 조회
      description: |
        현재 인증된 사용자의 프로필 및 구독 정보를 조회합니다.

        **엔드포인트 경로**:
        - `/user-api/me` - 사용자 프로필 + 구독 요약
        - `/user-api/subscription` - 구독 상세 정보
      operationId: getUserProfile
      security:
        - BearerAuth: []
      parameters:
        - name: endpoint
          in: path
          required: false
          description: 하위 엔드포인트 (me 또는 subscription)
          schema:
            type: string
            enum: [me, subscription]
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/UserProfile'
                  - $ref: '#/components/schemas/SubscriptionDetail'
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '404':
          description: 리소스 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'
        '429':
          description: Rate Limit 초과
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
            X-RateLimit-Reset:
              schema:
                type: integer
            Retry-After:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

  /subscription-api:
    get:
      tags:
        - Subscription
      summary: 구독 기능 및 사용량 조회
      description: |
        구독 플랜의 기능 목록, 현재 사용량, 접근 가능 여부를 조회합니다.

        **엔드포인트 경로**:
        - `/subscription-api/features?plan_id={id}` - 플랜 기능 목록
        - `/subscription-api/usage` - 현재 사용량
        - `/subscription-api/can-access?feature_key={key}` - 기능 접근 가능 여부
      operationId: getSubscriptionInfo
      security:
        - BearerAuth: []
      parameters:
        - name: endpoint
          in: path
          required: false
          description: 하위 엔드포인트
          schema:
            type: string
            enum: [features, usage, can-access]
        - name: plan_id
          in: query
          required: false
          description: 플랜 ID (features 엔드포인트에서 필수)
          schema:
            type: string
            format: uuid
        - name: feature_key
          in: query
          required: false
          description: 기능 키 (can-access 엔드포인트에서 필수)
          schema:
            type: string
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PlanFeatures'
                  - $ref: '#/components/schemas/UsageResponse'
                  - $ref: '#/components/schemas/CanAccessResponse'
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

    post:
      tags:
        - Subscription
      summary: 사용량 증가
      description: |
        특정 기능의 사용량을 증가시킵니다.

        **엔드포인트 경로**:
        - `/subscription-api/usage/increment` - 사용량 1 증가
      operationId: incrementUsage
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncrementRequest'
      responses:
        '200':
          description: 증가 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncrementResponse'
        '403':
          description: 사용 제한 초과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

  /api-v1-health:
    get:
      tags:
        - Health
      summary: 서비스 상태 조회
      description: |
        시스템 및 컴포넌트 상태를 확인합니다.
        데이터베이스 연결, 응답 시간 등을 측정하여 전체 시스템 상태를 반환합니다.
      operationId: getHealth
      responses:
        '200':
          description: 서비스 정상 또는 성능 저하
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
        '503':
          description: 서비스 이용 불가
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        OAuth 2.0 Access Token (JWT)

        **획득 방법**:
        1. `/oauth-authorize`로 Authorization Code 발급
        2. `/oauth-token`으로 Access Token 교환

        **사용 예시**:
        ```
        Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        ```

  schemas:
    # OAuth Request/Response
    AuthorizationCodeGrantRequest:
      type: object
      required:
        - grant_type
        - code
        - redirect_uri
        - client_id
        - code_verifier
      properties:
        grant_type:
          type: string
          enum: [authorization_code]
        code:
          type: string
          description: Authorization Code
          example: ac_abc123...
        redirect_uri:
          type: string
          format: uri
          description: 인증 시 사용한 redirect_uri와 동일해야 함
        client_id:
          type: string
          description: OAuth 클라이언트 ID
        code_verifier:
          type: string
          description: PKCE code_challenge 생성 시 사용한 원본 값

    RefreshTokenGrantRequest:
      type: object
      required:
        - grant_type
        - refresh_token
        - client_id
      properties:
        grant_type:
          type: string
          enum: [refresh_token]
        refresh_token:
          type: string
          description: Refresh Token
          example: rt_def456...
        client_id:
          type: string
          description: OAuth 클라이언트 ID

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT Access Token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          enum: [Bearer]
        expires_in:
          type: integer
          description: 만료 시간 (초)
          example: 3600
        refresh_token:
          type: string
          description: Refresh Token (authorization_code grant에서만 반환)
          example: rt_def456...
        scope:
          type: string
          description: 승인된 권한 범위 (공백으로 구분)
          example: profile subscription:read

    RevokeRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: 폐기할 Access Token 또는 Refresh Token
        token_type_hint:
          type: string
          enum: [access_token, refresh_token]
          description: 토큰 타입 힌트 (선택)
        client_id:
          type: string
          description: OAuth 클라이언트 ID (선택)

    ErrorResponse:
      type: object
      required:
        - error
        - error_description
      properties:
        error:
          type: string
          description: OAuth 2.0 에러 코드
          enum:
            - invalid_request
            - invalid_client
            - invalid_grant
            - unauthorized_client
            - unsupported_grant_type
            - invalid_scope
            - server_error
        error_description:
          type: string
          description: 에러 상세 설명
          example: 필수 파라미터가 누락되었습니다.

    # User API
    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 사용자 ID
        email:
          type: string
          format: email
          description: 이메일 주소
        full_name:
          type: string
          nullable: true
          description: 표시 이름
        avatar_url:
          type: string
          format: uri
          nullable: true
          description: 프로필 이미지 URL
        created_at:
          type: string
          format: date-time
          description: 계정 생성일
        subscription:
          $ref: '#/components/schemas/SubscriptionInfo'
          nullable: true

    SubscriptionInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: 구독 ID
        service_id:
          type: string
          format: uuid
          description: 서비스 ID
        service_name:
          type: string
          description: 서비스 이름
          example: Find
        plan_id:
          type: string
          format: uuid
          description: 플랜 ID
        plan_name:
          type: string
          description: 플랜 이름
          example: Pro
        billing_cycle:
          type: string
          enum: [monthly, yearly]
          description: 결제 주기
        price:
          type: number
          format: float
          description: 가격
        status:
          type: string
          enum: [trial, active, past_due, canceled, expired]
          description: 구독 상태
        trial_end_date:
          type: string
          format: date-time
          nullable: true
          description: 체험 종료일
        current_period_start:
          type: string
          format: date-time
          description: 현재 구독 기간 시작일
        current_period_end:
          type: string
          format: date-time
          description: 현재 구독 기간 종료일
        next_billing_date:
          type: string
          format: date-time
          nullable: true
          description: 다음 결제일
        cancel_at_period_end:
          type: boolean
          description: 기간 종료 시 취소 여부
        created_at:
          type: string
          format: date-time
          description: 구독 생성일

    SubscriptionDetail:
      type: object
      properties:
        subscription:
          $ref: '#/components/schemas/SubscriptionInfo'
        usage:
          type: object
          properties:
            total_payments:
              type: integer
              description: 총 결제 횟수
            last_payment_date:
              type: string
              format: date-time
              nullable: true
              description: 마지막 결제일
            total_amount_paid:
              type: number
              format: float
              description: 총 결제 금액
        features:
          type: array
          items:
            type: string
          description: 플랜 기능 목록
        next_payment:
          type: object
          properties:
            amount:
              type: number
              format: float
              description: 다음 결제 금액
            date:
              type: string
              format: date-time
              nullable: true
              description: 다음 결제일

    # Subscription API
    PlanFeatures:
      type: object
      properties:
        plan_id:
          type: string
          format: uuid
        plan_name:
          type: string
          example: Pro
        billing_cycle:
          type: string
          enum: [monthly, yearly]
        features:
          type: array
          items:
            type: object
            properties:
              icon:
                type: string
                description: 아이콘 이름
              text:
                type: string
                description: 기능 설명
              limit:
                type: integer
                nullable: true
                description: 제한 횟수 (무제한은 -1)

    UsageResponse:
      type: object
      properties:
        subscription_id:
          type: string
          format: uuid
        plan_name:
          type: string
        billing_cycle:
          type: string
        current_period_start:
          type: string
          format: date-time
        current_period_end:
          type: string
          format: date-time
        features:
          type: array
          items:
            $ref: '#/components/schemas/FeatureUsage'

    FeatureUsage:
      type: object
      properties:
        feature_key:
          type: string
          description: 기능 키
          example: monthly_analyses
        used_count:
          type: integer
          description: 사용 횟수
        limit:
          type: integer
          description: 제한 횟수 (무제한은 -1)
        remaining:
          type: integer
          description: 남은 횟수
        period_start:
          type: string
          format: date-time
        period_end:
          type: string
          format: date-time

    IncrementRequest:
      type: object
      required:
        - feature_key
      properties:
        feature_key:
          type: string
          description: 증가시킬 기능 키
          example: monthly_analyses

    IncrementResponse:
      type: object
      properties:
        success:
          type: boolean
        feature_key:
          type: string
        used_count:
          type: integer
          description: 현재 사용 횟수
        remaining:
          type: integer
          description: 남은 횟수

    CanAccessResponse:
      type: object
      properties:
        can_access:
          type: boolean
          description: 접근 가능 여부
        feature_key:
          type: string
        used_count:
          type: integer
        limit:
          type: integer
        remaining:
          type: integer

    # Health API
    HealthCheckResponse:
      type: object
      required:
        - status
        - version
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: 전체 시스템 상태
        version:
          type: string
          description: API 버전
          example: 1.0.0
        timestamp:
          type: string
          format: date-time
          description: 응답 시간
        components:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ComponentHealth'
        response_time_ms:
          type: integer
          description: 응답 시간 (밀리초)

    ComponentHealth:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        latency_ms:
          type: integer
          description: 레이턴시 (밀리초)
        message:
          type: string
          description: 상태 메시지
        metadata:
          type: object
          additionalProperties: true

    # Common Error
    ApiErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
            - request_id
            - timestamp
          properties:
            code:
              type: string
              description: 에러 코드
              example: unauthorized
            message:
              type: string
              description: 에러 메시지
              example: 유효하지 않은 토큰입니다.
            request_id:
              type: string
              format: uuid
              description: 요청 ID (디버깅용)
            timestamp:
              type: string
              format: date-time
              description: 에러 발생 시간

    # JWT Payload (참고용)
    JWTPayload:
      type: object
      description: JWT Access Token Payload (복호화 후)
      properties:
        sub:
          type: string
          format: uuid
          description: 사용자 ID
        iss:
          type: string
          format: uri
          description: 발급자
          example: https://www.ideaonaction.ai
        aud:
          type: array
          items:
            type: string
          description: 대상 서비스
          example: [minu.best]
        exp:
          type: integer
          description: 만료 시간 (Unix timestamp)
        iat:
          type: integer
          description: 발급 시간 (Unix timestamp)
        scope:
          type: string
          description: 권한 범위
          example: profile subscription:read
        subscription:
          type: object
          nullable: true
          description: 구독 정보 (활성 구독이 있는 경우)
          properties:
            plan_id:
              type: string
              format: uuid
            plan_name:
              type: string
              example: Pro
            status:
              type: string
              enum: [trial, active]
            expires_at:
              type: string
              format: date-time
            services:
              type: array
              items:
                type: string
              description: 서비스 슬러그 목록
              example: [find, frame]
