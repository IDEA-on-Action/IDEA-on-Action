# RAG 인수 조건

> RAG (Retrieval-Augmented Generation) 통합의 성공 기준 및 검증 방법

**작성일**: 2025-11-25
**버전**: 1.0.0
**상태**: Draft
**관련 명세**: [requirements.md](requirements.md)

---

## 1. 문서 처리 파이프라인 (FR-RAG-01)

### AC-RAG-01.1: 텍스트 추출

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-01.1.1 | PDF 파일 업로드 시 텍스트 정확하게 추출 (정확도 95%+) | 통합 테스트 |
| AC-RAG-01.1.2 | Word(.docx) 파일 업로드 시 텍스트 정확하게 추출 (정확도 95%+) | 통합 테스트 |
| AC-RAG-01.1.3 | Markdown 파일 업로드 시 포맷 유지하며 추출 | 통합 테스트 |
| AC-RAG-01.1.4 | 50MB 파일 업로드 시 60초 이내 처리 완료 | 성능 테스트 |
| AC-RAG-01.1.5 | 추출 실패 시 사용자에게 명확한 에러 메시지 표시 | E2E 테스트 |

### AC-RAG-01.2: 텍스트 청킹

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-01.2.1 | 긴 문서를 500-1000 토큰 단위로 분할 | 단위 테스트 |
| AC-RAG-01.2.2 | 청크 간 100 토큰 오버랩 유지 | 단위 테스트 |
| AC-RAG-01.2.3 | 문단 경계에서 분할 (문장 중간 분할 금지) | 단위 테스트 |
| AC-RAG-01.2.4 | 100페이지 문서 30초 이내 청킹 완료 | 성능 테스트 |

### AC-RAG-01.3: 메타데이터 추출

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-01.3.1 | 문서 제목 자동 추출 (파일명 또는 첫 헤딩) | 통합 테스트 |
| AC-RAG-01.3.2 | PDF 페이지 번호 정확히 추출 | 통합 테스트 |
| AC-RAG-01.3.3 | Markdown 섹션 제목 추출 및 계층 유지 | 통합 테스트 |
| AC-RAG-01.3.4 | 파일 메타데이터 (작성일, 수정일) 저장 | DB 검증 |

---

## 2. 임베딩 생성 (FR-RAG-02)

### AC-RAG-02.1: 임베딩 API 호출

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-02.1.1 | OpenAI Embeddings API 성공적으로 호출 | 통합 테스트 |
| AC-RAG-02.1.2 | API 에러 시 재시도 로직 작동 (최대 3회) | 에러 테스트 |
| AC-RAG-02.1.3 | Rate Limit 도달 시 대기 후 재시도 | 부하 테스트 |
| AC-RAG-02.1.4 | 100개 청크 임베딩 생성 < 10초 | 성능 테스트 |

### AC-RAG-02.2: 임베딩 저장

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-02.2.1 | 임베딩 벡터 PostgreSQL에 정확히 저장 | DB 검증 |
| AC-RAG-02.2.2 | pgvector 인덱스 자동 생성 | 마이그레이션 검증 |
| AC-RAG-02.2.3 | 문서 삭제 시 관련 임베딩 모두 삭제 (CASCADE) | 통합 테스트 |
| AC-RAG-02.2.4 | 중복 임베딩 방지 (document_id + chunk_index UNIQUE) | DB 제약 검증 |

---

## 3. 벡터 검색 (FR-RAG-03)

### AC-RAG-03.1: 유사도 검색

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-03.1.1 | 쿼리 입력 시 Top-5 관련 청크 반환 < 500ms | 성능 테스트 |
| AC-RAG-03.1.2 | Cosine Similarity 정확히 계산 (소수점 4자리) | 단위 테스트 |
| AC-RAG-03.1.3 | 유사도 0.7 이상 결과만 반환 | 통합 테스트 |
| AC-RAG-03.1.4 | 검색 결과 없을 시 빈 배열 반환 (에러 아님) | E2E 테스트 |

### AC-RAG-03.2: 하이브리드 검색

**Given**: 사용자가 "RFP 작성 방법"을 검색
**When**: 하이브리드 검색 실행 (벡터 + 키워드)
**Then**:
- [ ] 벡터 검색 결과와 키워드 검색 결과 병합
- [ ] α=0.7 가중치 적용하여 점수 계산
- [ ] 최종 Top-5 결과 반환
- [ ] 실행 시간 < 2초

### AC-RAG-03.3: 필터링

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-03.3.1 | 날짜 범위 필터 적용 시 해당 기간 문서만 검색 | E2E 테스트 |
| AC-RAG-03.3.2 | 태그 필터 적용 시 해당 태그 문서만 검색 | E2E 테스트 |
| AC-RAG-03.3.3 | 권한 필터 자동 적용 (RLS) | 보안 테스트 |
| AC-RAG-03.3.4 | 문서 타입 필터 (PDF/Word/Markdown) | E2E 테스트 |

---

## 4. 컨텍스트 주입 (FR-RAG-04)

### AC-RAG-04.1: 프롬프트 구성

**Given**: 사용자가 "프로젝트 예산은 얼마인가요?"라고 질문
**When**: RAG 검색 후 Claude에게 전달
**Then**:
- [ ] 시스템 프롬프트에 "제공된 문서 기반 답변" 지시 포함
- [ ] 검색된 청크 3개를 [참고 문서] 섹션에 포함
- [ ] 각 청크에 출처 (문서명, 페이지) 명시
- [ ] 사용자 질문을 [User Question] 섹션에 포함
- [ ] 전체 프롬프트 토큰 수 < 10,000

### AC-RAG-04.2: 출처 표시

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-04.2.1 | 답변에 출처 문서명 표시 | E2E 테스트 |
| AC-RAG-04.2.2 | PDF 경우 페이지 번호 표시 | E2E 테스트 |
| AC-RAG-04.2.3 | 여러 문서 참조 시 모든 출처 표시 | E2E 테스트 |
| AC-RAG-04.2.4 | 출처 클릭 시 원본 문서로 이동 | E2E 테스트 |

### AC-RAG-04.3: 품질 보장

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-04.3.1 | 문서에 없는 내용 답변 시 "정보 없음" 명시 | 품질 테스트 |
| AC-RAG-04.3.2 | 모호한 질문 시 추가 정보 요청 | 품질 테스트 |
| AC-RAG-04.3.3 | 상충되는 문서 정보 시 두 가지 모두 제시 | 품질 테스트 |

---

## 5. 문서 관리 (FR-RAG-05)

### AC-RAG-05.1: 문서 업로드

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-05.1.1 | 드래그 앤 드롭으로 파일 업로드 | E2E 테스트 |
| AC-RAG-05.1.2 | 파일 선택 대화상자로 업로드 | E2E 테스트 |
| AC-RAG-05.1.3 | 업로드 진행률 표시 (0-100%) | E2E 테스트 |
| AC-RAG-05.1.4 | 업로드 완료 후 자동으로 임베딩 생성 시작 | 통합 테스트 |
| AC-RAG-05.1.5 | 임베딩 생성 완료 시 알림 표시 | E2E 테스트 |

### AC-RAG-05.2: 문서 조회

**Given**: 사용자가 문서 관리 페이지 접속
**When**: 문서 목록 로드
**Then**:
- [ ] 업로드한 문서 목록 표시 (제목, 날짜, 크기)
- [ ] 페이지네이션 (페이지당 20개)
- [ ] 정렬 (최신순/이름순/크기순)
- [ ] 검색 필터 (제목, 태그)
- [ ] 로딩 상태 표시

### AC-RAG-05.3: 문서 삭제

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-05.3.1 | 삭제 전 확인 대화상자 표시 | E2E 테스트 |
| AC-RAG-05.3.2 | 삭제 시 문서 + 임베딩 모두 제거 | DB 검증 |
| AC-RAG-05.3.3 | 다른 사용자 문서 삭제 불가 (RLS) | 보안 테스트 |
| AC-RAG-05.3.4 | 삭제 후 목록에서 즉시 제거 | E2E 테스트 |

### AC-RAG-05.4: 문서 업데이트

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-05.4.1 | 동일 문서 재업로드 시 기존 버전 대체 | 통합 테스트 |
| AC-RAG-05.4.2 | 재업로드 시 기존 임베딩 삭제 후 재생성 | 통합 테스트 |
| AC-RAG-05.4.3 | 버전 히스토리 저장 (최대 5개) | DB 검증 |

---

## 6. 성능 요구사항 (NFR-RAG-01)

### AC-RAG-06.1: 임베딩 생성 성능

| 문서 크기 | 목표 시간 | 검증 방법 |
|----------|----------|----------|
| 10페이지 | < 5초 | 성능 테스트 |
| 50페이지 | < 20초 | 성능 테스트 |
| 100페이지 | < 30초 | 성능 테스트 |

**Given**: 100페이지 PDF 업로드
**When**: 임베딩 생성 프로세스 실행
**Then**:
- [ ] 텍스트 추출 < 10초
- [ ] 청킹 < 5초
- [ ] 임베딩 API 호출 < 15초
- [ ] DB 저장 < 2초
- [ ] **총 30초 이내 완료**

### AC-RAG-06.2: 검색 성능

| 시나리오 | p50 | p95 | p99 |
|---------|-----|-----|-----|
| 단순 벡터 검색 | < 200ms | < 500ms | < 1s |
| 하이브리드 검색 | < 500ms | < 1s | < 2s |
| 필터 적용 검색 | < 300ms | < 800ms | < 1.5s |

### AC-RAG-06.3: 동시성

| 항목 | 목표 |
|------|------|
| 동시 검색 요청 | 50개 처리 가능 |
| 동시 업로드 | 10개 처리 가능 |
| DB 연결 풀 | 최소 20개 유지 |

---

## 7. 정확도 요구사항 (NFR-RAG-02)

### AC-RAG-07.1: 검색 정확도

**평가 데이터셋**: 100개 질문-답변 쌍

| 메트릭 | 목표 | 검증 방법 |
|--------|------|----------|
| Recall@5 | > 0.8 | 오프라인 평가 |
| Precision@5 | > 0.7 | 오프라인 평가 |
| MRR (Mean Reciprocal Rank) | > 0.75 | 오프라인 평가 |
| NDCG@5 | > 0.8 | 오프라인 평가 |

**Given**: 평가 데이터셋으로 검색 테스트
**When**: 100개 질문에 대해 Top-5 검색
**Then**:
- [ ] 80% 이상 질문에서 정답 문서가 Top-5에 포함 (Recall)
- [ ] Top-5 결과 중 70% 이상이 관련 문서 (Precision)
- [ ] 평균적으로 정답이 1~2번째에 위치 (MRR > 0.75)

### AC-RAG-07.2: 답변 품질

| 평가 항목 | 목표 | 검증 방법 |
|----------|------|----------|
| 정답률 | > 85% | 사용자 피드백 |
| 환각(Hallucination) 비율 | < 5% | 수동 검토 |
| 출처 정확도 | > 95% | 수동 검토 |

---

## 8. 사용성 테스트 시나리오

### 8.1 Minu Find 시나리오: 시장 조사 보고서 분석

**Given**: 시장 조사 PDF 3개 업로드
**When**: "주요 경쟁사는 누구인가요?" 질문
**Then**:
- [ ] 3개 보고서에서 경쟁사 언급 부분 검색
- [ ] 각 보고서별 경쟁사 목록 종합 제시
- [ ] 출처 보고서명 및 페이지 번호 표시
- [ ] 응답 시간 < 5초

### 8.2 Minu Frame 시나리오: RFP 템플릿 참조

**Given**: 과거 RFP 문서 10개 업로드
**When**: "정부 SI 프로젝트 RFP 작성해줘" 요청
**Then**:
- [ ] 정부 SI 관련 RFP 템플릿 검색
- [ ] 유사 프로젝트 요구사항 섹션 참조
- [ ] 표준 양식 준수하며 초안 생성
- [ ] 생성 시간 < 30초

### 8.3 Minu Build 시나리오: API 문서 기반 질의

**Given**: OpenAPI 스펙 파일 + README 업로드
**When**: "사용자 인증 API 사용법" 질문
**Then**:
- [ ] API 엔드포인트 정보 검색
- [ ] 인증 방법 (헤더, 토큰) 설명
- [ ] 예제 코드 제시
- [ ] 응답 시간 < 3초

### 8.4 Minu Keep 시나리오: 장애 이력 기반 해결책

**Given**: 과거 장애 보고서 20개 업로드
**When**: "DB 연결 끊김 오류 해결 방법" 질문
**Then**:
- [ ] 유사 장애 사례 검색
- [ ] 과거 해결 방법 제시
- [ ] 재발 방지 권고사항 포함
- [ ] 응답 시간 < 5초

---

## 9. 보안 테스트

### AC-RAG-09.1: 권한 검증

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-09.1.1 | 비인증 사용자 문서 업로드 불가 | 보안 테스트 |
| AC-RAG-09.1.2 | 다른 사용자 문서 조회 불가 (RLS) | 보안 테스트 |
| AC-RAG-09.1.3 | 다른 사용자 문서 삭제 불가 (RLS) | 보안 테스트 |
| AC-RAG-09.1.4 | RAG 검색 시 본인 문서만 검색 | 보안 테스트 |

### AC-RAG-09.2: 데이터 보호

| ID | 조건 | 검증 방법 |
|----|------|----------|
| AC-RAG-09.2.1 | 업로드 파일 서버 측 검증 (MIME 타입) | 보안 테스트 |
| AC-RAG-09.2.2 | 악성 파일 업로드 차단 | 보안 테스트 |
| AC-RAG-09.2.3 | 문서 내용 XSS 방어 | 보안 테스트 |
| AC-RAG-09.2.4 | API 키 클라이언트 노출 없음 | 코드 리뷰 |

---

## 10. 에러 처리

### AC-RAG-10.1: 업로드 에러

| 시나리오 | 에러 메시지 | 검증 |
|---------|-----------|------|
| 파일 크기 초과 (>50MB) | "파일 크기는 50MB 이하여야 합니다." | E2E |
| 지원하지 않는 형식 | "PDF, Word, Markdown 파일만 지원합니다." | E2E |
| 텍스트 추출 실패 | "파일을 읽을 수 없습니다. 손상된 파일일 수 있습니다." | E2E |
| 네트워크 오류 | "업로드 실패. 다시 시도해주세요." | E2E |

### AC-RAG-10.2: 검색 에러

| 시나리오 | 동작 | 검증 |
|---------|------|------|
| 검색 결과 없음 | 빈 배열 반환 + "관련 문서를 찾을 수 없습니다." 메시지 | E2E |
| OpenAI API 장애 | 재시도 3회 → 실패 시 에러 표시 | 통합 |
| DB 연결 끊김 | 자동 재연결 → 실패 시 에러 표시 | 통합 |

---

## 11. 검증 일정

### Sprint 1: 기반 인프라 (1주)

- [ ] AC-RAG-01.1.1 ~ AC-RAG-01.1.5 (텍스트 추출)
- [ ] AC-RAG-01.2.1 ~ AC-RAG-01.2.4 (텍스트 청킹)
- [ ] AC-RAG-02.1.1 ~ AC-RAG-02.1.4 (임베딩 API)
- [ ] AC-RAG-02.2.1 ~ AC-RAG-02.2.4 (임베딩 저장)

### Sprint 2: 검색 및 통합 (1주)

- [ ] AC-RAG-03.1.1 ~ AC-RAG-03.1.4 (유사도 검색)
- [ ] AC-RAG-03.2 (하이브리드 검색)
- [ ] AC-RAG-04.1 (프롬프트 구성)
- [ ] AC-RAG-04.2.1 ~ AC-RAG-04.2.4 (출처 표시)
- [ ] AC-RAG-05.1.1 ~ AC-RAG-05.1.5 (문서 업로드)

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0.0 | 2025-11-25 | 초기 작성 | Claude |
