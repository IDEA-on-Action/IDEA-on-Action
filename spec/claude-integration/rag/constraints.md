# RAG 제약사항

> RAG 통합 시 고려해야 할 기술적, 비용적, 보안적 제약사항

**작성일**: 2025-11-25
**버전**: 1.0.0
**상태**: Draft
**관련 명세**: [requirements.md](requirements.md)

---

## 1. 기술적 제약사항

### 1.1 pgvector 제약

| 항목 | 제약 | 영향 | 대응 방안 |
|------|------|------|----------|
| 벡터 차원 | 최대 2000차원 | OpenAI large 모델(3072) 사용 불가 | text-embedding-3-small(1536) 사용 |
| 인덱스 타입 | IVFFlat, HNSW | 완벽한 Exact Search 아님 | 정확도 vs 속도 트레이드오프 |
| 메모리 사용 | 인덱스가 RAM에 상주 | 대용량 임베딩 시 메모리 부족 | 주기적 인덱스 재구축 |
| 동시성 | VACUUM 중 성능 저하 | 검색 응답 시간 증가 | 오프피크 시간 VACUUM |

#### 1.1.1 인덱스 선택 기준

| 인덱스 | 정확도 | 속도 | 메모리 | 권장 사용 |
|--------|--------|------|--------|----------|
| IVFFlat | 중간 (90-95%) | 빠름 | 낮음 | < 100만 벡터 (현재 사용) |
| HNSW | 높음 (95-99%) | 매우 빠름 | 높음 | > 100만 벡터 (향후) |

### 1.2 Supabase 제약

| 항목 | 제약 | 영향 | 대응 방안 |
|------|------|------|----------|
| DB 크기 | Pro 플랜 8GB | 임베딩 저장 제한 | 주기적 정리, 압축 |
| Edge Function 타임아웃 | 60초 | 긴 문서 처리 제한 | 비동기 처리 + 큐 |
| Storage 크기 | Pro 플랜 100GB | 원본 문서 저장 제한 | S3 마이그레이션 고려 |
| 동시 연결 | Pro 플랜 200개 | 트래픽 급증 시 제한 | 연결 풀 최적화 |

#### 1.2.1 스토리지 추정

| 항목 | 단위 크기 | 1,000개 | 10,000개 |
|------|----------|---------|----------|
| 원본 문서 | 5MB | 5GB | 50GB |
| 임베딩 (1536차원) | 6KB | 6MB | 60MB |
| 메타데이터 | 1KB | 1MB | 10MB |
| **총계** | - | **5.1GB** | **50.1GB** |

### 1.3 OpenAI API 제약

| 항목 | 제약 | 영향 | 대응 방안 |
|------|------|------|----------|
| Rate Limit (Tier 1) | 3,000 RPM | 동시 임베딩 생성 제한 | 배치 처리 + 큐 |
| 토큰 제한 (Tier 1) | 1M TPM | 대량 문서 처리 제한 | 점진적 처리 |
| 입력 크기 | 8191 토큰/요청 | 긴 청크 처리 불가 | 청크 크기 1000 토큰으로 제한 |
| 비용 | $0.02 / 1M 토큰 | 대량 문서 시 비용 증가 | 캐싱, 중복 제거 |

#### 1.3.1 예상 비용 시나리오

| 시나리오 | 문서 수 | 평균 페이지 | 총 토큰 | 비용 |
|---------|---------|------------|---------|------|
| 소규모 (스타트업) | 100 | 20 | 2M | $0.04 |
| 중규모 (SMB) | 1,000 | 20 | 20M | $0.40 |
| 대규모 (엔터프라이즈) | 10,000 | 20 | 200M | $4.00 |

**참고**: 재임베딩(업데이트) 비용 별도

### 1.4 Supabase Edge Function 제약

| 항목 | 제약 | 영향 | 대응 방안 |
|------|------|------|----------|
| 메모리 | 50MB | PDF 파싱 제한 | 청크 단위 처리 |
| CPU | 1 vCPU | 복잡한 계산 느림 | 간단한 전처리만 |
| Cold Start | 1-3초 | 첫 요청 느림 | 웜업 크론잡 |
| 동시 실행 | 계정당 제한 | 동시성 제약 | 큐 시스템 |

---

## 2. 성능 제약사항

### 2.1 검색 응답 시간

| 벡터 수 | IVFFlat (p95) | HNSW (p95) | 목표 |
|--------|--------------|-----------|------|
| 10K | 50ms | 20ms | < 500ms |
| 100K | 200ms | 50ms | < 500ms |
| 1M | 1s | 200ms | < 2s |

**현재 목표**: 100K 벡터까지 < 500ms

### 2.2 임베딩 생성 시간

| 문서 크기 | OpenAI API | 전처리 | DB 저장 | 총 시간 |
|----------|-----------|--------|---------|---------|
| 10페이지 | 2초 | 1초 | 0.5초 | **3.5초** |
| 50페이지 | 8초 | 3초 | 2초 | **13초** |
| 100페이지 | 15초 | 5초 | 3초 | **23초** |

**제약**: Supabase Edge Function 60초 타임아웃

### 2.3 동시 처리 제한

| 작업 | 목표 동시성 | 제약 요인 | 대응 |
|------|------------|----------|------|
| 문서 업로드 | 10개 | Edge Function 실행 수 | 큐 + 순차 처리 |
| 임베딩 생성 | 5개 | OpenAI Rate Limit | 배치 + 재시도 |
| 벡터 검색 | 50개 | DB 연결 풀 | 연결 풀 확장 |

---

## 3. 데이터 제약사항

### 3.1 문서 크기 제한

| 항목 | 권장 | 최대 | 초과 시 대응 |
|------|------|------|------------|
| 파일 크기 | 10MB | 50MB | 분할 업로드 유도 |
| 페이지 수 | 100페이지 | 500페이지 | 청크 단위 처리 |
| 텍스트 길이 | 50K 토큰 | 200K 토큰 | 자동 분할 |

### 3.2 청크 제약

| 항목 | 값 | 이유 |
|------|------|------|
| 최소 청크 크기 | 100 토큰 | 의미 있는 단위 보장 |
| 최대 청크 크기 | 1000 토큰 | OpenAI 입력 제한 |
| 오버랩 | 100 토큰 | 맥락 유지 |
| 최대 청크 수/문서 | 500개 | DB 부하 방지 |

### 3.3 검색 결과 제한

| 항목 | 값 | 이유 |
|------|------|------|
| Top-K | 5개 | Claude 컨텍스트 절약 |
| 유사도 임계값 | 0.7 | 관련성 보장 |
| 최대 컨텍스트 토큰 | 10,000 | Claude 200K의 5% |

---

## 4. 비용 제약사항

### 4.1 OpenAI Embeddings 비용

| 항목 | 단가 | 월 예상 사용 | 월 비용 |
|------|------|------------|---------|
| 임베딩 생성 | $0.02 / 1M 토큰 | 100M 토큰 | $2.00 |
| 재임베딩 (업데이트) | $0.02 / 1M 토큰 | 20M 토큰 | $0.40 |
| **총계** | - | - | **$2.40** |

### 4.2 Supabase 비용

| 플랜 | 월 비용 | DB 크기 | Storage | 대역폭 |
|------|---------|---------|---------|--------|
| Free | $0 | 500MB | 1GB | 2GB |
| Pro | $25 | 8GB | 100GB | 250GB |
| **권장** | **Pro** | **충분** | **충분** | **충분** |

### 4.3 총 예상 비용

| 항목 | 월 비용 |
|------|---------|
| OpenAI Embeddings | $2.40 |
| Supabase Pro | $25.00 |
| **총계** | **$27.40** |

**참고**: 기존 Claude AI 비용($27)에 추가

---

## 5. 보안 제약사항

### 5.1 데이터 보호

| 항목 | 정책 | 제약 |
|------|------|------|
| 문서 암호화 | 저장 시 AES-256 | Supabase 기본 제공 |
| 임베딩 격리 | 사용자별 RLS | PostgreSQL RLS |
| 전송 암호화 | TLS 1.3 | Supabase 기본 제공 |
| 백업 | 일일 자동 | Pro 플랜 30일 보관 |

### 5.2 접근 제어

| 레벨 | 정책 | 구현 방법 |
|------|------|----------|
| 문서 업로드 | 인증된 사용자만 | Supabase Auth |
| 문서 조회 | 본인 문서만 | RLS 정책 |
| 임베딩 접근 | Edge Function만 | Service Role Key |
| API 키 | 서버 측만 접근 | Edge Function 환경 변수 |

### 5.3 PII 처리

| 항목 | 정책 | 제약 |
|------|------|------|
| 개인정보 마스킹 | 선택 기능 제공 | 정규식 기반 (완벽하지 않음) |
| OpenAI 전송 | 사용자 동의 필요 | 이용약관 업데이트 |
| 보관 기간 | 30일 | 삭제 요청 시 즉시 삭제 |

---

## 6. 품질 제약사항

### 6.1 검색 정확도

| 메트릭 | 목표 | 현실적 한계 |
|--------|------|-----------|
| Recall@5 | > 0.8 | 임베딩 모델 성능에 의존 |
| Precision@5 | > 0.7 | 하이브리드 검색으로 개선 |
| MRR | > 0.75 | Re-ranking으로 개선 |

**제약 요인**:
- 임베딩 모델의 언어 이해 한계
- 도메인 특화 지식 부족
- 맥락 이해 부족 (단순 벡터 유사도)

### 6.2 답변 품질

| 항목 | 목표 | 제약 |
|------|------|------|
| 정답률 | > 85% | 문서 품질에 의존 |
| 환각 비율 | < 5% | Claude 모델 한계 |
| 출처 정확도 | > 95% | 청킹 경계 문제 |

**제약 요인**:
- 문서 품질 (오타, 오류)
- 청킹 경계에서 맥락 손실
- Claude의 환각(Hallucination)

---

## 7. 확장성 제약사항

### 7.1 현재 시스템 한계

| 항목 | 현재 지원 | 병목 지점 |
|------|----------|----------|
| 문서 수 | 1,000개 | 임베딩 생성 속도 |
| 임베딩 수 | 100K개 | pgvector 인덱스 크기 |
| 동시 사용자 | 100명 | DB 연결 풀 |
| 검색 QPS | 50 | DB CPU |

### 7.2 스케일링 전략

| 목표 | 대응 방안 | 예상 비용 증가 |
|------|----------|---------------|
| 10K 문서 | DB 플랜 업그레이드 (Team) | +$50/월 |
| 1M 임베딩 | HNSW 인덱스 + 더 큰 인스턴스 | +$100/월 |
| 1,000 동시 사용자 | Read Replica 추가 | +$25/월 |

### 7.3 장기 확장 제약

| 항목 | 제약 | 마이그레이션 필요 시점 |
|------|------|---------------------|
| DB 크기 | Supabase 최대 플랜 | > 500GB |
| 벡터 검색 | pgvector 성능 한계 | > 10M 벡터 |
| 비용 | Supabase 비용 증가 | > $500/월 |

**대안**: Pinecone, Weaviate 등 전문 벡터 DB

---

## 8. 운영 제약사항

### 8.1 모니터링

| 항목 | 도구 | 제약 |
|------|------|------|
| 검색 지연 | Supabase 대시보드 | 실시간 아님 (5분 지연) |
| 에러율 | Sentry | 무료 플랜 한도 |
| 비용 추적 | OpenAI Console | 일일 집계만 |

### 8.2 백업 및 복구

| 항목 | 정책 | 제약 |
|------|------|------|
| DB 백업 | 일일 자동 | Pro 플랜 30일 보관 |
| 임베딩 재생성 | 수동 트리거 | 시간 소요 (100개/시간) |
| 문서 복원 | 30일 이내 | 이후 영구 삭제 |

### 8.3 유지보수

| 작업 | 주기 | 제약 |
|------|------|------|
| VACUUM | 주 1회 | 성능 저하 (5-10분) |
| 인덱스 재구축 | 월 1회 | Downtime 필요 (선택) |
| 오래된 문서 정리 | 분기 1회 | 수동 작업 |

---

## 9. 법규 및 컴플라이언스 제약

### 9.1 개인정보보호

| 항목 | 요구사항 | 제약 |
|------|----------|------|
| 개인정보 처리 동의 | AI 분석 목적 명시 | 이용약관 업데이트 필요 |
| 제3자 제공 | OpenAI 전송 고지 | 개인정보처리방침 업데이트 |
| 삭제 요청 | 7일 이내 완전 삭제 | 백업 삭제 포함 |

### 9.2 OpenAI 데이터 정책

| 항목 | OpenAI 정책 | 영향 |
|------|------------|------|
| 데이터 학습 | 임베딩 API는 학습 미사용 | 안심하고 사용 가능 |
| 데이터 보관 | 30일간 보관 (안전 모니터링) | 민감 데이터 주의 |

### 9.3 라이선스

| 라이브러리 | 라이선스 | 제약 |
|-----------|---------|------|
| pgvector | PostgreSQL | 상업적 사용 가능 |
| pdf-parse | MIT | 상업적 사용 가능 |
| mammoth | BSD-2-Clause | 상업적 사용 가능 |

---

## 10. 대응 전략

### 10.1 단기 대응 (현재 ~ 6개월)

| 제약 | 대응 방안 |
|------|----------|
| OpenAI Rate Limit | 배치 처리 + 큐 시스템 |
| DB 크기 | 주기적 정리 (오래된 문서 삭제) |
| 검색 속도 | IVFFlat 인덱스 최적화 |
| 비용 | 캐싱 + 중복 제거 |

### 10.2 중기 대응 (6개월 ~ 1년)

| 제약 | 대응 방안 |
|------|----------|
| 1M 벡터 초과 | HNSW 인덱스로 전환 |
| Supabase Pro 한계 | Team 플랜으로 업그레이드 |
| 동시 사용자 증가 | Read Replica 추가 |

### 10.3 장기 대응 (1년 이후)

| 제약 | 대응 방안 |
|------|----------|
| 10M 벡터 초과 | Pinecone/Weaviate 마이그레이션 |
| 비용 > $500/월 | 자체 호스팅 고려 (Milvus) |
| 글로벌 확장 | Edge 리전 분산 |

---

## 11. 위험 평가

### 11.1 고위험 제약

| 제약 | 영향도 | 발생 가능성 | 완화 방안 |
|------|--------|------------|----------|
| OpenAI API 장애 | 높음 | 낮음 | 폴백 UI, 캐싱 |
| Supabase Downtime | 높음 | 낮음 | 백업 DB 준비 |
| 비용 폭증 | 중간 | 중간 | 사용량 알림, 한도 설정 |

### 11.2 중위험 제약

| 제약 | 영향도 | 발생 가능성 | 완화 방안 |
|------|--------|------------|----------|
| 검색 속도 저하 | 중간 | 중간 | 인덱스 최적화 |
| DB 크기 초과 | 중간 | 높음 | 정기 정리 자동화 |
| 정확도 저하 | 낮음 | 중간 | Re-ranking, 피드백 |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0.0 | 2025-11-25 | 초기 작성 | Claude |
