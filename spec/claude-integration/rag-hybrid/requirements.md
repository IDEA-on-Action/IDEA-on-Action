# RAG 하이브리드 검색 요구사항 명세서

**작성일**: 2025-11-26
**버전**: 2.19.0
**상태**: Draft
**담당자**: AI Agent
**관련 문서**:
- [RAG Integration Spec](../rag/requirements.md)
- [Claude Integration Plan](../../plan/claude-integration/architecture.md)

---

## 1. 개요

### 1.1 목적
키워드 검색(Full-Text Search)과 벡터 검색(Semantic Search)을 결합하여 RAG 시스템의 검색 정확도를 향상시킵니다.

### 1.2 배경
- **현재 상태**: 벡터 검색만 사용 (semantic similarity)
- **문제점**:
  - 정확한 키워드 매칭이 필요한 경우 정확도 저하
  - 전문 용어, 고유명사 검색 시 누락 가능성
  - 사용자가 검색 방식을 선택할 수 없음
- **해결 방안**: 두 검색 방식을 가중치 기반으로 결합

### 1.3 범위
- **포함**:
  - 하이브리드 검색 DB 함수 개선
  - React 훅 (useRAGHybridSearch)
  - UI 컴포넌트 (가중치 조절, 점수 표시)
  - E2E 테스트
- **제외**:
  - 기존 벡터 검색 기능 변경
  - 새로운 임베딩 모델 도입

---

## 2. 사용자 스토리

### US-01: 하이브리드 검색 실행
**As a** 사용자
**I want to** 키워드와 의미를 동시에 고려한 검색을 실행하고 싶다
**So that** 더 정확한 검색 결과를 얻을 수 있다

**인수 조건**:
- [ ] 검색 쿼리 입력 시 자동으로 하이브리드 검색 실행
- [ ] 결과에 키워드 점수, 벡터 점수, 통합 점수 표시
- [ ] 0.5초 이내 응답 시간
- [ ] 중복 결과 자동 제거

### US-02: 검색 가중치 조절
**As a** 고급 사용자
**I want to** 키워드 검색과 벡터 검색의 비중을 조절하고 싶다
**So that** 상황에 맞는 최적의 검색 결과를 얻을 수 있다

**인수 조건**:
- [ ] 키워드 가중치 슬라이더 (0.0 ~ 1.0)
- [ ] 벡터 가중치 슬라이더 (0.0 ~ 1.0)
- [ ] 가중치 합계 1.0 유지 (자동 조정)
- [ ] 실시간 검색 결과 업데이트

### US-03: 검색 결과 점수 시각화
**As a** 사용자
**I want to** 각 검색 결과의 점수를 시각적으로 확인하고 싶다
**So that** 왜 이 결과가 나왔는지 이해할 수 있다

**인수 조건**:
- [ ] 키워드 점수 프로그레스 바 (0~100%)
- [ ] 벡터 점수 프로그레스 바 (0~100%)
- [ ] 통합 점수 강조 표시
- [ ] 점수별 색상 구분 (높음: 초록, 중간: 노랑, 낮음: 회색)

### US-04: 프로젝트별 필터링
**As a** 프로젝트 관리자
**I want to** 특정 프로젝트의 문서만 검색하고 싶다
**So that** 관련 없는 결과를 제외할 수 있다

**인수 조건**:
- [ ] 프로젝트 선택 드롭다운
- [ ] "전체 프로젝트" 옵션
- [ ] 프로젝트 변경 시 자동 재검색

---

## 3. 기능 요구사항

### FR-01: 하이브리드 검색 알고리즘
- **ID**: FR-01
- **우선순위**: P0
- **설명**: 키워드 검색과 벡터 검색 결과를 가중치 기반으로 결합

**세부 요구사항**:
1. 키워드 검색 (Full-Text Search)
   - PostgreSQL `to_tsvector`, `plainto_tsquery` 사용
   - `ts_rank` 기반 점수 계산
   - 'simple' 설정 사용 (한글/영문 혼용 지원)

2. 벡터 검색 (Semantic Search)
   - pgvector cosine similarity (`<=>` 연산자)
   - OpenAI text-embedding-3-small (1536 차원)
   - 유사도 = 1 - cosine_distance

3. 점수 결합
   - `combined_score = (keyword_score * keyword_weight) + (vector_score * vector_weight)`
   - 기본 가중치: keyword=0.3, vector=0.7
   - 가중치 범위: 0.0 ~ 1.0
   - 가중치 합계: keyword_weight + vector_weight = 1.0

4. 결과 정렬
   - `combined_score` 내림차순
   - 동점 시 `created_at` 최신순

### FR-02: 가중치 조절 인터페이스
- **ID**: FR-02
- **우선순위**: P1
- **설명**: 사용자가 검색 가중치를 조절할 수 있는 UI

**세부 요구사항**:
1. 키워드 가중치 슬라이더
   - 범위: 0.0 ~ 1.0
   - 단계: 0.05
   - 기본값: 0.3
   - 레이블: "키워드 검색 ({value}%)"

2. 벡터 가중치 슬라이더
   - 범위: 0.0 ~ 1.0
   - 단계: 0.05
   - 기본값: 0.7
   - 레이블: "의미 검색 ({value}%)"

3. 자동 조정
   - 한 슬라이더 변경 시 다른 슬라이더 자동 조정
   - 합계 항상 1.0 유지
   - 디바운스 300ms

### FR-03: 검색 결과 시각화
- **ID**: FR-03
- **우선순위**: P1
- **설명**: 검색 결과에 점수를 시각적으로 표시

**세부 요구사항**:
1. 점수 표시
   - 키워드 점수: 프로그레스 바 + 퍼센트
   - 벡터 점수: 프로그레스 바 + 퍼센트
   - 통합 점수: 큰 배지 + 퍼센트

2. 색상 코딩
   - 80% 이상: `bg-green-500` (높은 관련성)
   - 60% ~ 80%: `bg-yellow-500` (중간 관련성)
   - 60% 미만: `bg-gray-400` (낮은 관련성)

3. 정렬 표시
   - 순위 번호 (#1, #2, ...)
   - 통합 점수 기준 정렬

### FR-04: 프로젝트 필터링
- **ID**: FR-04
- **우선순위**: P2
- **설명**: 특정 프로젝트의 문서만 검색

**세부 요구사항**:
1. 프로젝트 선택
   - 드롭다운 UI
   - "전체 프로젝트" 옵션 (기본값)
   - 사용자의 프로젝트 목록 로드

2. 필터링 로직
   - `project_id` 기반 필터링
   - NULL 시 전체 프로젝트 검색
   - RLS 정책 준수 (자신의 프로젝트 + 공개 프로젝트)

---

## 4. 비기능 요구사항

### NFR-01: 성능
- **검색 응답 시간**: 500ms 이내 (P95)
- **동시 검색 처리**: 100 req/s
- **인덱스 활용률**: 95% 이상

### NFR-02: 확장성
- **문서 수**: 100,000개까지 지원
- **청크 수**: 1,000,000개까지 지원
- **검색 결과 한도**: 최대 50개

### NFR-03: 사용성
- **검색 입력 디바운스**: 300ms
- **로딩 인디케이터**: 300ms 이상 소요 시 표시
- **에러 메시지**: 사용자 친화적 한글 메시지

### NFR-04: 접근성
- **키보드 탐색**: 모든 컨트롤 키보드 접근 가능
- **스크린 리더**: aria-label 지원
- **색맹 대응**: 색상 + 텍스트 조합 사용

---

## 5. 제약사항

### 5.1 기술적 제약
- PostgreSQL 15+ (pgvector 지원)
- pgvector 0.5.0+ (cosine distance 지원)
- OpenAI API (임베딩 생성)
- React 18+ (Hooks)

### 5.2 보안 제약
- RLS 정책 준수 (사용자별 문서 접근)
- SQL Injection 방지 (Prepared Statements)
- Edge Function JWT 인증

### 5.3 데이터 제약
- 임베딩 차원: 1536 (고정)
- 청크 크기: 500자 (기존 유지)
- 검색 임계값: 0.7 (기본값)

---

## 6. 인수 조건

### AC-01: 하이브리드 검색 실행
- [ ] 검색 쿼리 입력 시 자동 실행
- [ ] 키워드 + 벡터 점수 모두 계산
- [ ] 통합 점수 기준 정렬
- [ ] 중복 결과 없음

### AC-02: 가중치 조절
- [ ] 슬라이더 값 변경 시 실시간 반영
- [ ] 가중치 합계 항상 1.0
- [ ] 검색 결과 즉시 업데이트
- [ ] 디바운스 적용 (300ms)

### AC-03: 점수 시각화
- [ ] 세 가지 점수 모두 표시
- [ ] 프로그레스 바 정확도 ±1%
- [ ] 색상 코딩 적용
- [ ] 순위 번호 표시

### AC-04: 프로젝트 필터링
- [ ] 프로젝트 목록 로드
- [ ] 선택 시 필터링 적용
- [ ] "전체" 선택 시 모든 프로젝트 검색
- [ ] RLS 정책 위반 없음

### AC-05: 성능
- [ ] 검색 응답 시간 500ms 이내
- [ ] 인덱스 사용 확인 (EXPLAIN ANALYZE)
- [ ] 100개 문서 검색 시 지연 없음

### AC-06: 에러 처리
- [ ] 네트워크 에러 시 재시도 UI
- [ ] 검색 실패 시 친화적 메시지
- [ ] 빈 결과 시 안내 메시지
- [ ] 로딩 상태 표시

---

## 7. 우선순위

| 기능 | 우선순위 | 이유 |
|------|----------|------|
| 하이브리드 검색 알고리즘 | P0 | 핵심 기능 |
| 가중치 조절 UI | P1 | 사용자 경험 |
| 점수 시각화 | P1 | 투명성 |
| 프로젝트 필터링 | P2 | 편의 기능 |

---

## 8. 관련 문서
- [RAG Integration Spec](../rag/requirements.md)
- [Claude Integration Plan](../../plan/claude-integration/architecture.md)
- [DB Migration: RAG Tables](../../../supabase/migrations/20251125200000_create_rag_documents.sql)
- [DB Migration: RAG Search](../../../supabase/migrations/20251125200002_create_rag_search_function.sql)

---

**검토 이력**:
- 2025-11-26: 초안 작성 (AI Agent)
