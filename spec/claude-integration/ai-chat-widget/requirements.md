# AI 채팅 위젯 요구사항 정의

> Claude AI 통합 - 사이트 전역 채팅 위젯
>
> **Stage**: Specify (명세 작성)
> **작성일**: 2025-11-25
> **담당**: Claude & 서민원

---

## 📋 개요

### 목적
사이트의 모든 페이지에서 사용자가 언제든지 Claude AI와 대화할 수 있는 플로팅 채팅 위젯을 제공합니다.

### 배경
- **현재 상황**: AI 기능이 특정 페이지에만 존재 (RFP 생성기, 이미지 분석 등)
- **문제점**: 사용자가 일반적인 질문이나 도움이 필요할 때 접근 경로가 불명확함
- **해결 방안**: 사이트 전역에서 접근 가능한 플로팅 채팅 위젯 제공
- **기대 효과**: 사용자 참여도 향상, AI 기능 활용도 증가, 고객 지원 자동화

### 핵심 가치
1. **접근성**: 어떤 페이지에서든 클릭 한 번으로 AI 어시스턴트 이용
2. **컨텍스트 인식**: 현재 페이지 정보를 AI가 자동으로 인식
3. **대화 연속성**: 로그인 사용자는 대화 기록 저장 및 재개 가능
4. **서비스 특화**: Minu 서비스(Find, Frame, Build, Keep)별 맞춤 답변

---

## 👥 사용자 스토리

### US-001: 방문자가 사이트 어디서든 AI와 대화
**As a** 사이트 방문자
**I want to** 화면 하단의 플로팅 버튼을 클릭하여 AI와 대화하고
**So that** 궁금한 점을 즉시 해결하고 서비스에 대한 정보를 얻을 수 있다

**인수 조건**:
- [ ] 사이트 모든 페이지 우하단에 플로팅 버튼 표시
- [ ] 버튼 클릭 시 채팅 창이 열림
- [ ] 비회원도 사용 가능 (세션 기반)
- [ ] 모바일에서도 동일하게 작동

**시나리오**:
```
Given 사용자가 홈페이지를 방문했을 때
When 우하단의 AI 어시스턴트 버튼을 클릭하면
Then 채팅 창이 열리고 환영 메시지가 표시된다

Given 사용자가 "/services/minu-find" 페이지에 있을 때
When 채팅 창을 열면
Then AI가 "Minu Find 서비스에 대해 도와드릴까요?"라고 인사한다
```

---

### US-002: 로그인 사용자가 대화 기록 저장
**As a** 로그인한 사용자
**I want to** 이전 대화 내용을 저장하고 나중에 다시 이어서 대화하고
**So that** 중요한 정보를 잃지 않고 필요할 때 참조할 수 있다

**인수 조건**:
- [ ] 로그인 시 자동으로 대화 기록 저장
- [ ] 채팅 창 상단에 "대화 기록" 버튼 표시
- [ ] 이전 대화 세션 목록 보기 및 선택 가능
- [ ] 선택한 대화에서 이어서 채팅 가능

**시나리오**:
```
Given 로그인한 사용자가 어제 AI와 대화했을 때
When 오늘 채팅 창을 열고 "대화 기록" 버튼을 클릭하면
Then 어제 대화 내역이 목록으로 표시된다

Given 사용자가 특정 대화를 선택했을 때
When 해당 대화를 클릭하면
Then 이전 대화 내용이 로드되고 이어서 채팅할 수 있다
```

---

### US-003: Minu 서비스 관련 맞춤 답변
**As a** Minu 서비스 사용자
**I want to** 현재 보고 있는 서비스에 특화된 AI 답변을 받고
**So that** 더 정확하고 유용한 정보를 얻을 수 있다

**인수 조건**:
- [ ] AI가 현재 페이지의 서비스 ID 인식
- [ ] 서비스별 시스템 프롬프트 자동 적용
- [ ] Minu Find/Frame/Build/Keep 각각에 최적화된 답변 제공
- [ ] 프롬프트 템플릿 연동 (usePromptTemplates)

**시나리오**:
```
Given 사용자가 "/services/minu-find" 페이지에 있을 때
When "시장 분석을 어떻게 하나요?"라고 질문하면
Then AI가 Minu Find의 시장분석 Excel 생성 기능을 안내한다

Given 사용자가 "/services/minu-build" 페이지에 있을 때
When "프로젝트 리포트를 만들고 싶어요"라고 질문하면
Then AI가 Minu Build의 프로젝트 리포트 생성 기능을 안내한다
```

---

### US-004: 모바일에서 편리하게 채팅
**As a** 모바일 사용자
**I want to** 작은 화면에서도 불편함 없이 AI와 대화하고
**So that** 언제 어디서나 AI 도움을 받을 수 있다

**인수 조건**:
- [ ] 모바일 화면 크기에 맞춰 채팅 창 전체 화면 표시
- [ ] 플로팅 버튼이 화면을 가리지 않도록 위치 조정
- [ ] 키보드 열릴 때 입력창이 키보드에 가려지지 않음
- [ ] 터치 인터랙션 최적화 (스크롤, 탭, 드래그)

**시나리오**:
```
Given 모바일 사용자가 사이트에 접속했을 때
When 플로팅 버튼을 탭하면
Then 채팅 창이 전체 화면으로 열린다

Given 사용자가 메시지를 입력하려고 할 때
When 키보드가 나타나면
Then 입력창이 키보드 바로 위로 자동 이동한다
```

---

## 🎯 기능 요구사항

### FR-001: 플로팅 버튼
**우선순위**: P0 (필수)

**설명**: 사이트 전역에서 고정 위치에 표시되는 AI 어시스턴트 버튼

**상세 요구사항**:
- 위치: 화면 우하단 (모바일: 하단 중앙)
- 크기: 60x60px (데스크톱), 56x56px (모바일)
- 아이콘: Bot 아이콘 (Lucide `MessageCircle` 또는 `Bot`)
- 색상: Primary 브랜드 색상, 호버 시 어두워짐
- 애니메이션: 새 메시지 시 펄스 효과
- z-index: 1000 (다른 요소 위에 표시)
- 상태 표시: 온라인/오프라인 인디케이터

**기술 제약**:
- CSS `position: fixed` 사용
- 스크롤해도 위치 고정
- 모바일 네비게이션과 겹치지 않도록 bottom 여백 조정

---

### FR-002: 채팅 창
**우선순위**: P0 (필수)

**설명**: 메시지 표시 및 입력을 위한 채팅 인터페이스

**상세 요구사항**:
- 크기: 400x600px (데스크톱), 전체 화면 (모바일)
- 위치: 플로팅 버튼 위쪽 (데스크톱), 전체 화면 (모바일)
- 헤더: 제목 ("AI 어시스턴트"), 대화 기록 버튼, 닫기 버튼
- 본문: 메시지 목록 영역 (스크롤 가능)
- 푸터: 메시지 입력창, 전송 버튼
- 열기/닫기 애니메이션: Slide up/down (300ms)

**기술 제약**:
- 모바일에서 `position: fixed` + `inset: 0` 사용
- 데스크톱에서 `position: fixed` + `bottom: 80px, right: 20px`
- 스크롤 영역 격리 (body 스크롤과 독립)

---

### FR-003: 메시지 표시
**우선순위**: P0 (필수)

**설명**: 사용자 메시지와 AI 응답을 구분하여 표시

**상세 요구사항**:
- 사용자 메시지: 우측 정렬, Primary 색상 배경
- AI 메시지: 좌측 정렬, Gray 색상 배경
- 타임스탬프: 메시지 하단에 작게 표시 (예: "방금 전", "5분 전")
- 아바타: AI 메시지에만 Bot 아이콘 표시
- 마크다운 렌더링: 코드 블록, 링크, 볼드, 이탤릭 지원
- 자동 스크롤: 새 메시지 추가 시 하단으로 자동 스크롤

**기술 제약**:
- `react-markdown` 또는 간단한 HTML 변환 함수 사용
- 코드 블록은 syntax highlighting 적용 (선택)
- XSS 방지를 위해 sanitize 처리

---

### FR-004: 스트리밍 응답
**우선순위**: P0 (필수)

**설명**: AI 응답을 실시간으로 스트리밍하여 표시

**상세 요구사항**:
- `useClaudeStreaming` 훅 사용
- 응답이 오는 동안 타이핑 애니메이션 표시
- 스트리밍 중 메시지 전송 버튼 비활성화
- 사용자가 중지 버튼 클릭 시 스트리밍 중단
- 스트리밍 완료 후 메시지 DB 저장

**기술 제약**:
- `useClaudeStreaming({ onStreamingText: ... })` 활용
- 스트리밍 중에도 기존 메시지는 스크롤 가능
- AbortController로 취소 구현

---

### FR-005: 대화 기록 저장
**우선순위**: P1 (중요)

**설명**: 로그인 사용자의 대화 내역을 Supabase에 저장

**상세 요구사항**:
- `useConversationManager` 훅 사용
- 대화 세션 자동 생성 (제목: "AI 어시스턴트 대화 - {날짜}")
- 메시지 전송 시마다 DB에 저장
- 비회원: LocalStorage에 임시 저장 (최대 50개 메시지)
- 로그인 시 LocalStorage 데이터를 DB로 마이그레이션 옵션 제공

**기술 제약**:
- `ai_conversations`, `ai_messages` 테이블 사용
- RLS 정책으로 본인 대화만 조회 가능
- 로그인 상태 변경 감지 (`useAuth`)

---

### FR-006: 페이지 컨텍스트 인식
**우선순위**: P1 (중요)

**설명**: 현재 페이지 정보를 AI에게 자동으로 제공

**상세 요구사항**:
- 현재 URL, 페이지 제목, 서비스 ID 추출
- 서비스 페이지(`/services/:serviceId`)인 경우 서비스 정보 포함
- 시스템 프롬프트에 컨텍스트 정보 삽입
- 사용자가 명시적으로 질문하지 않아도 페이지 관련 정보 제공

**예시**:
```
현재 페이지: /services/minu-find
서비스: Minu Find (사업기회 탐색)
시스템 프롬프트: "당신은 Minu Find 서비스 전문가입니다. 사용자가 시장 분석, 경쟁사 비교, 사업 기회 탐색에 대해 질문하면 Minu Find의 Excel 생성 기능을 안내하세요."
```

**기술 제약**:
- React Router의 `useLocation`, `useParams` 사용
- 서비스 ID → 서비스 메타데이터 매핑 (상수 또는 API)
- 시스템 프롬프트 동적 생성

---

### FR-007: 프롬프트 템플릿 연동
**우선순위**: P2 (선택)

**설명**: 사전 정의된 프롬프트 템플릿을 채팅 위젯에서 선택 가능

**상세 요구사항**:
- `usePromptTemplates` 훅으로 공개 템플릿 목록 조회
- 채팅 입력창 상단에 "템플릿 선택" 드롭다운 (선택)
- 템플릿 선택 시 입력창에 자동 채움
- 변수 치환 UI 제공 (템플릿에 변수가 있는 경우)

**예시**:
```
템플릿: "RFP 생성 도움"
내용: "{{project_name}} 프로젝트의 RFP를 작성하려고 합니다. 어떤 정보가 필요한가요?"
변수: project_name

사용자가 선택하면 입력창에 표시:
"[프로젝트명] 프로젝트의 RFP를 작성하려고 합니다. 어떤 정보가 필요한가요?"
```

**기술 제약**:
- `prompt_templates` 테이블에서 `category: 'chat_widget'` 필터링
- 변수 치환은 `usePromptTemplates.replaceVariables()` 활용

---

## 🚫 비기능 요구사항

### NFR-001: 성능
- 채팅 창 열기/닫기 애니메이션 60fps 유지
- 스트리밍 응답 지연 시간 < 500ms (첫 청크)
- 메시지 100개까지 스크롤 버벅임 없이 렌더링

### NFR-002: 접근성
- 키보드 단축키: `Alt + C` (Chat) - 채팅 창 열기/닫기
- 플로팅 버튼에 `aria-label="AI 어시스턴트 열기"` 설정
- 메시지 입력창에 `placeholder` 및 `aria-label` 제공
- 스크린 리더 지원 (role, aria-live)

### NFR-003: 보안
- XSS 방지: 메시지 내용 sanitize
- 비회원 대화는 세션 종료 시 삭제 옵션 제공
- Rate Limiting: 사용자당 분당 10개 메시지 제한

### NFR-004: 호환성
- 브라우저: Chrome, Firefox, Safari, Edge (최신 2개 버전)
- 모바일: iOS Safari, Android Chrome
- 화면 크기: 320px (최소) ~ 1920px

---

## 📐 제약사항

### 기술 제약
1. **기존 훅 재사용 필수**:
   - `useClaudeStreaming` (스트리밍 메시지)
   - `useConversationManager` (대화 기록)
   - `usePromptTemplates` (템플릿)
   - `useAuth` (로그인 상태)

2. **컴포넌트 구조**:
   - Radix UI 사용 (Dialog, Dropdown 등)
   - Tailwind CSS로 스타일링
   - shadcn/ui 디자인 토큰 준수

3. **상태 관리**:
   - React 상태로 충분 (Zustand 불필요)
   - 전역 상태: 채팅 창 열림/닫힘 여부만
   - 로컬 상태: 메시지 목록, 입력 텍스트

### 비즈니스 제약
1. **비용 관리**:
   - 비회원도 사용 가능하지만 세션당 10개 메시지 제한
   - 로그인 사용자는 일일 100개 메시지 제한
   - Claude API 토큰 사용량 모니터링

2. **컨텐츠 정책**:
   - 부적절한 질문 필터링 (욕설, 불법 내용)
   - 서비스 관련 질문 우선 응답
   - 일반 대화는 간단히만 응답

### 디자인 제약
1. **브랜드 일관성**:
   - Primary 색상: `hsl(var(--primary))` 사용
   - 폰트: Inter (본문), JetBrains Mono (코드)
   - 아이콘: Lucide Icons

2. **반응형**:
   - 데스크톱: 플로팅 윈도우
   - 태블릿: 플로팅 윈도우 (크기 조정)
   - 모바일: 전체 화면

---

## 📊 성공 지표

### 정량적 지표
- **채팅 위젯 오픈율**: 방문자의 20% 이상이 위젯 열기
- **평균 대화 길이**: 사용자당 평균 5개 이상 메시지 교환
- **문제 해결률**: AI 답변 후 추가 질문 없이 종료 70% 이상
- **응답 속도**: 평균 첫 청크 응답 시간 < 1초

### 정성적 지표
- 사용자 피드백: "도움이 되었나요?" 긍정 평가 80% 이상
- 고객 지원 티켓 감소: AI 위젯 도입 후 10% 감소
- 사용자 체류 시간 증가: AI 사용자 평균 +20% 체류

---

## 🔗 관련 문서

- **기술 스택**: [CLAUDE.md](../../CLAUDE.md)
- **Claude 통합**: [spec/claude-integration/requirements.md](../requirements.md)
- **대화 컨텍스트**: [spec/claude-integration/conversation-context/requirements.md](../conversation-context/requirements.md)
- **프롬프트 템플릿**: [spec/claude-integration/prompt-templates/requirements.md](../prompt-templates/requirements.md)

---

## 📝 변경 이력

| 날짜 | 작성자 | 변경 내용 |
|------|--------|-----------|
| 2025-11-25 | Claude | 초안 작성 |
