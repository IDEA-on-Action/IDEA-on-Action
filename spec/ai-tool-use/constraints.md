# AI Tool Use 제약사항

> **작성일**: 2025-11-25
> **버전**: 1.0.0
> **상태**: Draft

---

## 📋 개요

AI Tool Use 기능 구현 시 반드시 준수해야 하는 기술적 제약사항, 비즈니스 규칙, 환경 제한을 정의합니다.

---

## 🔒 보안 제약사항

### CONS-SEC-001: 읽기 전용

- **제약**: 도구는 데이터 조회만 가능, 생성/수정/삭제 불가
- **이유**: 보안 위험 최소화, 잘못된 AI 판단으로 인한 데이터 손실 방지
- **예외**: 없음
- **검증**: 모든 도구는 SELECT 쿼리만 실행, INSERT/UPDATE/DELETE 금지

### CONS-SEC-002: RLS 필수

- **제약**: 모든 도구 실행은 Supabase RLS 정책 적용
- **이유**: 사용자가 권한 없는 데이터에 접근하지 못하도록
- **예외**: 관리자는 `role = 'admin'` 조건으로 전체 데이터 접근 가능
- **검증**: Service Role Key가 아닌 User Token으로 Supabase Client 생성

### CONS-SEC-003: 민감 정보 제외

- **제약**: 비밀번호, API 키, 토큰, 개인정보(주민번호, 카드번호) 조회 불가
- **이유**: GDPR, 개인정보보호법 준수
- **예외**: 없음
- **검증**: 도구 응답에 민감 필드 포함 시 테스트 실패

### CONS-SEC-004: JWT 검증 필수

- **제약**: 모든 도구 실행은 유효한 JWT 토큰 필요
- **이유**: 인증되지 않은 접근 차단
- **예외**: 없음
- **검증**: 토큰 없으면 `401 Unauthorized` 응답

---

## ⚡ 성능 제약사항

### CONS-PERF-001: 타임아웃 10초

- **제약**: 도구 실행은 10초 내에 완료되어야 함
- **이유**: 사용자 경험 저하 방지, Claude API 타임아웃 회피
- **예외**: 대용량 데이터 조회 시 페이지네이션 사용
- **검증**: 10초 초과 시 자동 중단, `is_error: true` 반환

### CONS-PERF-002: 결과 크기 제한

- **제약**: 도구 응답은 최대 10,000자 (약 10KB)
- **이유**: Claude API 콘텐츠 블록 크기 제한
- **예외**: 없음
- **검증**: 응답 길이 초과 시 잘림 + "더 많은 결과가 있습니다" 안내

### CONS-PERF-003: 페이지네이션 필수

- **제약**: 리스트 조회 시 기본 limit=20, 최대 limit=100
- **이유**: 대량 데이터 조회로 인한 성능 저하 방지
- **예외**: 없음
- **검증**: limit > 100이면 자동 100으로 변경

### CONS-PERF-004: 캐싱 제한

- **제약**: `health.tool`만 1분간 캐싱 가능
- **이유**: 실시간 데이터 신선도 유지
- **예외**: 헬스 체크는 자주 변하지 않음
- **검증**: 다른 도구는 항상 DB 조회

---

## 🌐 환경 제약사항

### CONS-ENV-001: Deno 환경

- **제약**: Supabase Edge Functions는 Deno 런타임
- **이유**: Supabase 인프라 제약
- **예외**: 없음
- **검증**: Node.js 전용 패키지 사용 불가

### CONS-ENV-002: ESM 모듈

- **제약**: 모든 모듈은 ESM 형식 (`import`/`export`)
- **이유**: Deno는 CommonJS 지원 제한적
- **예외**: 없음
- **검증**: `require()` 사용 금지

### CONS-ENV-003: 외부 의존성 최소화

- **제약**: npm 패키지 대신 Deno 표준 라이브러리 우선
- **이유**: 번들 크기, 배포 속도 최적화
- **예외**: Supabase Client는 필수
- **검증**: package.json 의존성 증가 최소화

### CONS-ENV-004: 프론트엔드 호환성

- **제약**: React 18 + TypeScript 5 환경
- **이유**: 기존 프로젝트 스택
- **예외**: 없음
- **검증**: 프론트엔드 빌드 성공

---

## 📐 데이터 제약사항

### CONS-DATA-001: 기존 스키마 유지

- **제약**: 도구는 기존 DB 스키마를 그대로 사용
- **이유**: 다른 기능과의 충돌 방지
- **예외**: 인덱스 추가는 허용 (성능 최적화)
- **검증**: 마이그레이션에서 테이블 수정 금지

### CONS-DATA-002: JOIN 제한

- **제약**: 도구 쿼리는 최대 2개 테이블 조인
- **이유**: 복잡한 쿼리로 인한 성능 저하 방지
- **예외**: 프로젝트-사용자 관계는 3개 조인 허용
- **검증**: 쿼리 실행 계획 분석

### CONS-DATA-003: 정렬 필수

- **제약**: 리스트 조회 시 정렬 기준 명시 필수
- **이유**: 일관된 결과 순서 보장
- **예외**: 없음
- **검증**: ORDER BY 절 없으면 테스트 실패

### CONS-DATA-004: 날짜 형식

- **제약**: 모든 날짜는 ISO 8601 형식 (YYYY-MM-DDTHH:mm:ss.sssZ)
- **이유**: Claude가 이해하기 쉬운 표준 형식
- **예외**: 없음
- **검증**: 날짜 파싱 테스트

---

## 🔄 통합 제약사항

### CONS-INT-001: Claude API 버전

- **제약**: Claude API 2024-10-22 버전 이상
- **이유**: Tool Use 기능은 최신 버전에서만 지원
- **예외**: 없음
- **검증**: API 요청 헤더 `anthropic-version` 확인

### CONS-INT-002: Rate Limit 공유

- **제약**: 도구 실행도 기존 Claude API Rate Limit 카운트
- **이유**: Anthropic 요금 정책 (API 호출 기준)
- **예외**: 없음
- **검증**: Rate Limit 카운터 증가 확인

### CONS-INT-003: 메시지 턴 제한

- **제약**: 도구 사용 시 최대 3턴 (user → tool_use → tool_result → assistant)
- **이유**: 복잡도 제한, 무한 루프 방지
- **예외**: 없음
- **검증**: 턴 수 추적, 초과 시 중단

### CONS-INT-004: 병렬 실행 불가

- **제약**: 여러 도구를 동시에 실행할 수 없음 (순차 실행)
- **이유**: Claude API는 한 번에 하나의 tool_use만 처리
- **예외**: 없음
- **검증**: 여러 도구 필요 시 순차 호출

---

## 📝 코드 제약사항

### CONS-CODE-001: TypeScript Strict

- **제약**: TypeScript strict mode 필수
- **이유**: 타입 안전성 보장
- **예외**: 없음
- **검증**: `tsconfig.json`의 `strict: true`

### CONS-CODE-002: any 타입 금지

- **제약**: `any` 타입 사용 금지 (unknown 사용)
- **이유**: 타입 체크 우회 방지
- **예외**: 서드파티 라이브러리 타입 불일치 시 임시 허용
- **검증**: ESLint 규칙 `@typescript-eslint/no-explicit-any`

### CONS-CODE-003: 에러 처리 필수

- **제약**: 모든 비동기 함수는 try-catch 필수
- **이유**: 예외 발생 시 graceful fallback
- **예외**: 없음
- **검증**: 에러 핸들링 없으면 테스트 실패

### CONS-CODE-004: 테스트 커버리지

- **제약**: 코드 커버리지 80% 이상
- **이유**: 안정성 보장
- **예외**: 타입 정의 파일은 제외
- **검증**: Jest 커버리지 리포트

---

## 🚫 금지 사항

### CONS-BAN-001: 외부 API 직접 호출

- **제약**: 도구에서 Minu 서비스 API를 직접 호출 금지
- **이유**: 인증, 에러 처리 복잡도 증가
- **예외**: 향후 Phase 2에서 검토
- **대안**: Supabase 테이블만 조회

### CONS-BAN-002: 사용자 입력 SQL 직접 실행

- **제약**: 사용자 입력을 SQL 문자열로 직접 연결 금지
- **이유**: SQL Injection 방지
- **예외**: 없음
- **대안**: 파라미터 바인딩 또는 Supabase Client 메서드 사용

### CONS-BAN-003: 도구 내 AI 호출

- **제약**: 도구 실행 중에 Claude API를 재호출 금지
- **이유**: 무한 루프, 비용 폭발 위험
- **예외**: 없음
- **대안**: 필요 시 여러 도구를 순차 실행

### CONS-BAN-004: 파일 시스템 접근

- **제약**: 도구는 파일 읽기/쓰기 불가
- **이유**: 보안, Supabase Edge Functions 제약
- **예외**: 없음
- **대안**: Supabase Storage 사용 (별도 구현)

---

## 🎯 비즈니스 제약사항

### CONS-BIZ-001: 무료 티어 제한

- **제약**: 무료 사용자는 일일 도구 실행 100회 제한
- **이유**: 비용 관리
- **예외**: 유료 구독자는 무제한
- **검증**: Rate Limit 로직에 티어별 한도 추가

### CONS-BIZ-002: 데이터 보존 기간

- **제약**: 도구 실행 로그는 30일 보관
- **이유**: 저장 공간 절약
- **예외**: 관리자 로그는 90일 보관
- **검증**: 자동 삭제 스케줄러

### CONS-BIZ-003: 이용 약관 동의

- **제약**: Tool Use 기능은 약관 동의 후 사용 가능
- **이유**: 법적 책임 명확화
- **예외**: 없음
- **검증**: 프론트엔드에서 동의 체크 후 활성화

---

## 📊 모니터링 제약사항

### CONS-MON-001: 로그 필수 항목

- **제약**: 모든 도구 실행은 아래 항목 로깅 필수
  - 사용자 ID
  - 도구 이름
  - 입력 파라미터
  - 실행 시간
  - 성공/실패 여부
- **이유**: 디버깅, 사용 패턴 분석
- **예외**: 민감 정보는 로깅 제외
- **검증**: 로그 항목 누락 시 테스트 실패

### CONS-MON-002: 알림 조건

- **제약**: 아래 조건 시 관리자 알림 발송
  - 에러율 10% 초과
  - P95 latency 1초 초과
  - Rate Limit 초과율 5% 초과
- **이유**: 서비스 품질 유지
- **예외**: 없음
- **검증**: 알림 시스템 통합 테스트

---

## 🔧 운영 제약사항

### CONS-OPS-001: 배포 전 스테이징 테스트

- **제약**: 프로덕션 배포 전 스테이징 환경에서 테스트 필수
- **이유**: 프로덕션 장애 최소화
- **예외**: Hotfix는 간소화된 테스트 허용
- **검증**: 스테이징 테스트 통과 확인

### CONS-OPS-002: 롤백 계획

- **제약**: 배포 시 롤백 계획 수립 필수
- **이유**: 문제 발생 시 빠른 복구
- **예외**: 없음
- **검증**: 롤백 스크립트 준비

### CONS-OPS-003: 점진적 배포

- **제약**: 새 도구는 10% 사용자에게 먼저 배포 (Canary)
- **이유**: 대규모 장애 방지
- **예외**: 긴급 보안 패치는 전체 배포
- **검증**: Feature Flag 사용

---

## 📚 문서 제약사항

### CONS-DOC-001: API 문서 작성

- **제약**: 모든 도구는 API 문서 필수
- **이유**: 개발자 온보딩, 유지보수 용이
- **예외**: 없음
- **검증**: OpenAPI Spec 생성

### CONS-DOC-002: 사용자 가이드

- **제약**: Tool Use 기능 사용자 가이드 필수
- **이유**: 사용자 교육
- **예외**: 없음
- **검증**: 가이드 페이지 퍼블리시

---

## ✅ 제약사항 체크리스트

**릴리스 전 확인**:
- [ ] 모든 보안 제약사항 준수 (CONS-SEC-001 ~ 004)
- [ ] 성능 제약사항 테스트 통과 (CONS-PERF-001 ~ 004)
- [ ] 환경 제약사항 확인 (CONS-ENV-001 ~ 004)
- [ ] 데이터 제약사항 검증 (CONS-DATA-001 ~ 004)
- [ ] 금지 사항 위반 0건 (CONS-BAN-001 ~ 004)
- [ ] 비즈니스 제약사항 구현 (CONS-BIZ-001 ~ 003)
- [ ] 모니터링 설정 완료 (CONS-MON-001 ~ 002)
- [ ] 운영 계획 수립 (CONS-OPS-001 ~ 003)
- [ ] 문서 작성 완료 (CONS-DOC-001 ~ 002)

---

**작성자**: Claude (AI Developer)
**리뷰어**: 서민원
**승인일**: TBD
