# =============================================================================
# IDEA on Action - Cloudflare Workers 설정
# Supabase Edge Functions → Cloudflare Workers 마이그레이션
# =============================================================================

name = "idea-on-action-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# 빌드 설정 (wrangler가 직접 esbuild 사용)
# [build]
# command = "npm run build"

# 개발 환경
[dev]
port = 8787
local_protocol = "http"

# =============================================================================
# 환경 변수 (민감하지 않은 값만)
# Secrets (wrangler secret put으로 설정):
#   JWT_SECRET, SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY,
#   TOSS_SECRET_KEY, SLACK_WEBHOOK_URL, OPENAI_API_KEY,
#   RESEND_API_KEY, INTERNAL_API_KEY, ANTHROPIC_API_KEY, MCP_JWT_SECRET
#
# OAuth Secrets (wrangler secret put으로 설정):
#   GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
#   GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET
#   KAKAO_CLIENT_ID, KAKAO_CLIENT_SECRET
#   MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET
#   APPLE_CLIENT_ID, APPLE_TEAM_ID, APPLE_KEY_ID, APPLE_PRIVATE_KEY
#
# OAuth Redirect URIs (wrangler secret put):
#   WORKER_URL = https://api.ideaonaction.ai
#   FRONTEND_URL = https://www.ideaonaction.ai
# =============================================================================
[vars]
ENVIRONMENT = "production"
API_VERSION = "2.40.0"
CORS_ORIGINS = "https://www.ideaonaction.ai,https://preview.ideaonaction.ai"
WORKER_URL = "https://api.ideaonaction.ai"
FRONTEND_URL = "https://www.ideaonaction.ai"

# =============================================================================
# KV Namespaces
# =============================================================================
[[kv_namespaces]]
binding = "SESSIONS"
id = "1872ad8ccd8245e693932fc12961dff9"

[[kv_namespaces]]
binding = "CACHE"
id = "b864bafab6064085a59ee94ee14baf70"

[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "50ed706000b14f0a952aa5250a64f416"

# =============================================================================
# D1 Database
# =============================================================================
[[d1_databases]]
binding = "DB"
database_name = "idea-on-action-db"
database_id = "53853270-e050-419c-be7e-446eca24d279"

# =============================================================================
# R2 Storage
# =============================================================================
[[r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "idea-on-action-media"

# =============================================================================
# Vectorize (RAG 검색)
# =============================================================================
[[vectorize]]
binding = "VECTORIZE"
index_name = "rag-embeddings"

# =============================================================================
# Durable Objects (실시간 WebSocket)
# =============================================================================
[durable_objects]
bindings = [
  { name = "REALTIME_ROOM", class_name = "RealtimeRoom" }
]

# Durable Objects Migrations
[[migrations]]
tag = "v1"
new_classes = ["RealtimeRoom"]

# =============================================================================
# 라우팅
# =============================================================================
[[routes]]
pattern = "api.ideaonaction.ai/*"
zone_name = "ideaonaction.ai"

# =============================================================================
# 스테이징 환경
# =============================================================================
[env.staging]
vars = { ENVIRONMENT = "staging" }
routes = [
  { pattern = "api-staging.ideaonaction.ai/*", zone_name = "ideaonaction.ai" }
]

# =============================================================================
# 개발 환경 (로컬 테스트용)
# =============================================================================
[env.development]
vars = { ENVIRONMENT = "development" }

# =============================================================================
# Cron Triggers (정기 작업)
# =============================================================================
# 구독 결제 처리: 매일 오전 9시 (KST) = UTC 00:00
[triggers]
crons = ["0 0 * * *"]
