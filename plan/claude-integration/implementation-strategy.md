# Claude AI 통합 구현 전략

> Claude AI 통합을 위한 스프린트 구성 및 작업 분배 전략

**작성일**: 2025-11-24
**버전**: 1.0.0
**상태**: Draft
**관련 문서**:
- [architecture.md](architecture.md)
- [tech-stack.md](tech-stack.md)

---

## 1. 구현 개요

### 1.1 목표

IDEA on Action 프로젝트에 Claude AI를 안전하고 효율적으로 통합하여:
- 사용자에게 AI 기반 문서 생성 기능 제공
- RFP 작성, 요약, 분석 등 업무 자동화 지원
- 기존 Minu 시리즈 서비스와 연계

### 1.2 범위

| 포함 | 제외 |
|------|------|
| Edge Function 프록시 | 자체 LLM 호스팅 |
| React 훅 (3종) | 복잡한 에이전트 |
| 기본 Rate Limiting | 과금 시스템 |
| 사용량 로깅 | 파인튜닝 |
| 스트리밍 응답 | 비전/이미지 분석 (Phase 2) |

### 1.3 타임라인

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Claude AI 통합 구현 타임라인                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Sprint 1 (인프라)                  Sprint 2 (클라이언트)                 │
│  ══════════════════                 ══════════════════════               │
│  예상: 8시간                         예상: 8시간                          │
│                                                                          │
│  ┌─────────────────────┐           ┌─────────────────────┐              │
│  │ DB 마이그레이션      │           │ React 훅 구현        │              │
│  │ Edge Function       │           │ Claude Client       │              │
│  │ Rate Limiting       │           │ 채팅 UI             │              │
│  │ 사용량 로깅         │           │ E2E 테스트          │              │
│  └─────────────────────┘           └─────────────────────┘              │
│            │                                 │                           │
│            │                                 │                           │
│            ▼                                 ▼                           │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                         통합 테스트 & 배포                         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  총 예상 시간: 16~20시간                                                 │
│  병렬 에이전트: 4개 (작업 병렬화)                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Sprint 1: 인프라 구축 (8시간)

### 2.1 개요

백엔드 인프라 구축에 집중하는 스프린트입니다.

| 항목 | 내용 |
|------|------|
| **기간** | 8시간 (병렬 작업 시 4시간) |
| **목표** | Edge Function + DB + Rate Limiting |
| **병렬 작업** | 4개 에이전트 동시 진행 |
| **의존성** | 없음 (독립 실행 가능) |

### 2.2 작업 목록

```
Sprint 1: Claude 인프라
├── TASK-001: DB 마이그레이션 (1.5시간) ─────────────┐
├── TASK-002: claude-proxy Edge Function (3시간) ───┼─ 병렬 가능
├── TASK-003: Rate Limiting 구현 (2시간) ───────────┤
└── TASK-004: 사용량 로깅 시스템 (1.5시간) ──────────┘
```

#### TASK-001: DB 마이그레이션

**예상 시간**: 1.5시간
**담당**: 에이전트 1

**산출물**:
- `supabase/migrations/YYYYMMDDHHMMSS_claude_tables.sql`

**작업 내용**:
```sql
-- 생성할 테이블
1. claude_usage_logs     -- 사용량 기록
2. claude_rate_limits    -- Rate Limit 상태
3. claude_response_cache -- 응답 캐시 (선택)

-- 생성할 인덱스
- user_id, created_at 기반 인덱스

-- RLS 정책
- 사용자 본인 데이터만 조회
- service_role만 쓰기 가능
```

**완료 기준**:
- [ ] 마이그레이션 파일 생성
- [ ] 로컬에서 마이그레이션 성공
- [ ] RLS 정책 테스트 통과

---

#### TASK-002: claude-proxy Edge Function

**예상 시간**: 3시간
**담당**: 에이전트 2

**산출물**:
- `supabase/functions/claude-proxy/index.ts`

**작업 내용**:
```typescript
// 엔드포인트
POST /functions/v1/claude-proxy/messages         // 단일 응답
POST /functions/v1/claude-proxy/messages/stream  // 스트리밍
GET  /functions/v1/claude-proxy/usage            // 사용량 조회

// 기능
- Supabase Auth JWT 검증
- @anthropic-ai/sdk 호출
- 스트리밍 응답 (SSE) 포워딩
- 에러 핸들링 및 로깅
```

**완료 기준**:
- [ ] Edge Function 생성 및 배포
- [ ] JWT 인증 동작 확인
- [ ] 단일 응답 API 동작 확인
- [ ] 스트리밍 응답 API 동작 확인
- [ ] 에러 응답 형식 확인

---

#### TASK-003: Rate Limiting 구현

**예상 시간**: 2시간
**담당**: 에이전트 3

**산출물**:
- `supabase/functions/claude-proxy/rate-limiter.ts`

**작업 내용**:
```typescript
// Token Bucket 알고리즘
interface RateLimiter {
  check(userId: string): Promise<{ allowed: boolean; remaining: number }>;
  consume(userId: string, tokens: number): Promise<void>;
  refill(): void;
}

// 제한 기준
- RPM: 60 요청/분 (기본)
- TPM: 100,000 토큰/분 (기본)
- Daily: 1,000,000 토큰/일 (기본)

// 사용자 등급별 차등
- user: 기본
- premium: 2배
- admin: 무제한
```

**완료 기준**:
- [ ] Token Bucket 로직 구현
- [ ] DB 연동 (상태 저장)
- [ ] 429 응답 테스트
- [ ] 사용자 등급별 차등 적용

---

#### TASK-004: 사용량 로깅 시스템

**예상 시간**: 1.5시간
**담당**: 에이전트 4

**산출물**:
- `supabase/functions/claude-proxy/usage-logger.ts`

**작업 내용**:
```typescript
// 로깅 항목
interface UsageLog {
  userId: string;
  requestId: string;
  model: string;
  inputTokens: number;
  outputTokens: number;
  latencyMs: number;
  stream: boolean;
  errorCode?: string;
}

// 기능
- 비동기 로깅 (응답 차단 방지)
- 배치 처리 (선택)
- 통계 집계 함수
```

**완료 기준**:
- [ ] 로깅 모듈 구현
- [ ] 성공/실패 모두 로깅 확인
- [ ] 통계 쿼리 동작 확인

---

### 2.3 Sprint 1 의존성 그래프

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Sprint 1 의존성 그래프                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  독립 작업 (병렬 실행 가능)                                               │
│  ═════════════════════════                                               │
│                                                                          │
│  ┌─────────────────┐                                                    │
│  │   TASK-001      │                                                    │
│  │ DB 마이그레이션  │ ─────────────┐                                     │
│  └─────────────────┘              │                                     │
│                                    │                                     │
│  ┌─────────────────┐              ▼                                     │
│  │   TASK-002      │       ┌─────────────────┐                          │
│  │ Edge Function   │ ────> │    통합 테스트   │                          │
│  │ (기본 구조)      │       │   (Sprint 1)    │                          │
│  └─────────────────┘       └─────────────────┘                          │
│                                    ▲                                     │
│  ┌─────────────────┐              │                                     │
│  │   TASK-003      │              │                                     │
│  │ Rate Limiting   │ ─────────────┤                                     │
│  └─────────────────┘              │                                     │
│                                    │                                     │
│  ┌─────────────────┐              │                                     │
│  │   TASK-004      │              │                                     │
│  │ 사용량 로깅      │ ─────────────┘                                     │
│  └─────────────────┘                                                    │
│                                                                          │
│  ** 모든 TASK는 병렬 실행 가능 **                                        │
│  ** DB 스키마가 먼저 완료되어야 다른 TASK에서 테스트 가능 **              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Sprint 2: 클라이언트 구현 (8시간)

### 3.1 개요

프론트엔드 클라이언트 구현에 집중하는 스프린트입니다.

| 항목 | 내용 |
|------|------|
| **기간** | 8시간 (병렬 작업 시 4시간) |
| **목표** | React 훅 + Claude Client + UI |
| **병렬 작업** | 4개 에이전트 동시 진행 |
| **의존성** | Sprint 1 완료 필요 |

### 3.2 작업 목록

```
Sprint 2: Claude 클라이언트
├── TASK-005: TypeScript 타입 정의 (1시간) ──────────┐
├── TASK-006: Claude Client 라이브러리 (2시간) ──────┤
├── TASK-007: React 훅 구현 (2.5시간) ───────────────┼─ 순차 의존
├── TASK-008: 채팅 UI 컴포넌트 (1.5시간) ────────────┤
└── TASK-009: E2E 테스트 작성 (1시간) ───────────────┘
```

#### TASK-005: TypeScript 타입 정의

**예상 시간**: 1시간
**담당**: 에이전트 1

**산출물**:
- `src/types/claude.types.ts`

**작업 내용**:
```typescript
// 정의할 타입
- ClaudeModel (모델 타입)
- ClaudeMessage (메시지)
- ChatMessage (UI용 확장)
- ClaudeGenerateOptions
- ClaudeChatOptions
- ClaudeStreamOptions
- ClaudeResponse
- ClaudeError
- UsageStats
```

**완료 기준**:
- [ ] 모든 타입 정의 완료
- [ ] JSDoc 주석 포함
- [ ] 타입 체크 통과

---

#### TASK-006: Claude Client 라이브러리

**예상 시간**: 2시간
**담당**: 에이전트 2
**의존성**: TASK-005

**산출물**:
- `src/lib/claude-client.ts`
- `src/lib/claude-query.ts`

**작업 내용**:
```typescript
// ClaudeClient 클래스
class ClaudeClient {
  generate(prompt, options): Promise<Response>
  chat(messages, options): Promise<Response>
  stream(prompt, options): AsyncGenerator<string>
  getUsage(): Promise<UsageStats>
}

// Query 설정
- claudeQueryKeys (캐시 키)
- claudeQueryConfig (캐싱 설정)
```

**완료 기준**:
- [ ] 클라이언트 클래스 구현
- [ ] 인증 헤더 자동 주입
- [ ] 에러 핸들링 구현
- [ ] 스트리밍 파싱 동작

---

#### TASK-007: React 훅 구현

**예상 시간**: 2.5시간
**담당**: 에이전트 3
**의존성**: TASK-005, TASK-006

**산출물**:
- `src/hooks/useClaudeGenerate.ts`
- `src/hooks/useClaudeChat.ts`
- `src/hooks/useClaudeStream.ts`
- `src/hooks/useClaudeUsage.ts`

**작업 내용**:
```typescript
// useClaudeGenerate
- 단일 응답 생성
- React Query mutation 기반
- 로딩/에러 상태 관리

// useClaudeChat
- 대화 컨텍스트 관리
- 히스토리 유지
- 초기화 기능

// useClaudeStream
- 스트리밍 응답 처리
- 중단 기능
- 청크별 업데이트

// useClaudeUsage
- 사용량 조회
- 캐싱 적용
```

**완료 기준**:
- [ ] 4개 훅 구현 완료
- [ ] TypeScript 타입 완전 지원
- [ ] 스트리밍 중단 동작 확인
- [ ] 캐싱 동작 확인

---

#### TASK-008: 채팅 UI 컴포넌트

**예상 시간**: 1.5시간
**담당**: 에이전트 4
**의존성**: TASK-007

**산출물**:
- `src/components/claude/ClaudeChat.tsx`
- `src/components/claude/ClaudeMessage.tsx`
- `src/components/claude/ClaudeInput.tsx`
- `src/components/claude/ClaudeUsageCard.tsx`

**작업 내용**:
```typescript
// ClaudeChat
- 메시지 목록 표시
- 입력 폼
- 스트리밍 타이핑 효과

// ClaudeMessage
- 사용자/AI 메시지 구분
- 마크다운 렌더링
- 토큰 사용량 표시

// ClaudeInput
- 텍스트 입력
- 전송 버튼
- 로딩 상태

// ClaudeUsageCard
- 일/월 사용량
- 남은 한도
- 그래프 (선택)
```

**완료 기준**:
- [ ] 컴포넌트 4개 구현
- [ ] 반응형 디자인
- [ ] 다크 모드 지원
- [ ] 접근성 준수

---

#### TASK-009: E2E 테스트 작성

**예상 시간**: 1시간
**담당**: 에이전트 1 (또는 병렬)
**의존성**: TASK-007, TASK-008

**산출물**:
- `tests/e2e/claude-integration.spec.ts`

**작업 내용**:
```typescript
// 테스트 시나리오
describe('Claude Integration', () => {
  test('단일 메시지 생성')
  test('대화 컨텍스트 유지')
  test('스트리밍 응답 표시')
  test('스트리밍 중단')
  test('Rate Limit 처리')
  test('인증 실패 처리')
  test('사용량 표시')
})
```

**완료 기준**:
- [ ] 7개 이상 테스트 케이스
- [ ] 모든 테스트 통과
- [ ] CI 파이프라인 연동

---

### 3.3 Sprint 2 의존성 그래프

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Sprint 2 의존성 그래프                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  순차 의존 관계                                                           │
│  ═══════════════                                                         │
│                                                                          │
│  ┌─────────────────┐                                                    │
│  │   TASK-005      │                                                    │
│  │ 타입 정의        │                                                    │
│  └────────┬────────┘                                                    │
│           │                                                              │
│           ▼                                                              │
│  ┌─────────────────┐                                                    │
│  │   TASK-006      │                                                    │
│  │ Claude Client   │                                                    │
│  └────────┬────────┘                                                    │
│           │                                                              │
│           ▼                                                              │
│  ┌─────────────────┐      ┌─────────────────┐                           │
│  │   TASK-007      │      │   TASK-008      │                           │
│  │ React 훅        │ ───> │ UI 컴포넌트      │ ─── 부분 병렬             │
│  └────────┬────────┘      └────────┬────────┘                           │
│           │                        │                                     │
│           └────────────┬───────────┘                                     │
│                        │                                                 │
│                        ▼                                                 │
│               ┌─────────────────┐                                        │
│               │   TASK-009      │                                        │
│               │ E2E 테스트       │                                        │
│               └─────────────────┘                                        │
│                                                                          │
│  ** TASK-005 → 006 → 007/008 → 009 순차 진행 **                         │
│  ** TASK-007, 008은 부분 병렬 가능 **                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 병렬 작업 분배

### 4.1 Sprint 1 병렬 분배

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Sprint 1 병렬 작업 분배                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  시간    에이전트 1    에이전트 2    에이전트 3    에이전트 4              │
│  ────   ──────────   ──────────   ──────────   ──────────              │
│                                                                          │
│  0h     ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐              │
│         │ TASK-001│  │ TASK-002│  │ TASK-003│  │ TASK-004│              │
│         │ DB 마이그│  │ Edge Fn │  │ Rate    │  │ 사용량  │              │
│  1h     │         │  │ (1/3)   │  │ Limiting│  │ 로깅    │              │
│         │         │  │         │  │ (1/2)   │  │ (1/2)   │              │
│  1.5h   └─────────┘  │         │  │         │  └─────────┘              │
│                      │         │  └─────────┘                            │
│  2h     [대기/리뷰]   │         │                                         │
│                      │         │  [리뷰/지원]                             │
│  3h                  └─────────┘                                         │
│                                                                          │
│  4h     ═══════════════ 통합 테스트 ═══════════════                      │
│                                                                          │
│  예상 완료: 4~5시간 (병렬 실행 시)                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Sprint 2 병렬 분배

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Sprint 2 병렬 작업 분배                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  시간    에이전트 1    에이전트 2    에이전트 3    에이전트 4              │
│  ────   ──────────   ──────────   ──────────   ──────────              │
│                                                                          │
│  0h     ┌─────────┐                                                     │
│         │ TASK-005│                                                     │
│         │ 타입 정의│                                                     │
│  1h     └─────────┘                                                     │
│              │                                                           │
│              ▼                                                           │
│         ┌─────────┐  ┌─────────┐                                        │
│         │[리뷰]   │  │ TASK-006│                                        │
│  2h     │         │  │ Client  │                                        │
│         │         │  └─────────┘                                        │
│  3h     │         │      │                                               │
│         │         │      ▼                                               │
│         │         │  ┌─────────┐  ┌─────────┐                           │
│         │         │  │ TASK-007│  │ TASK-008│  <- 병렬 시작             │
│  4h     │         │  │ 훅 구현  │  │ UI 구현  │                           │
│         │ TASK-009│  │         │  │         │                           │
│  5h     │ E2E     │  └─────────┘  └─────────┘                           │
│         │ 테스트   │                                                     │
│  6h     └─────────┘                                                     │
│                                                                          │
│  예상 완료: 5~6시간 (부분 병렬)                                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 위험 요소 및 대응

### 5.1 기술적 위험

| 위험 | 확률 | 영향 | 대응 방안 |
|------|------|------|----------|
| Anthropic API 키 오류 | 낮음 | 높음 | 환경 변수 사전 검증 |
| Rate Limit 설계 복잡성 | 중간 | 중간 | 단순 카운터로 시작, 점진 개선 |
| 스트리밍 SSE 호환성 | 중간 | 중간 | 폴백 (일반 응답) 구현 |
| Edge Function 콜드 스타트 | 낮음 | 낮음 | 워밍업 요청 (선택) |

### 5.2 일정 위험

| 위험 | 확률 | 영향 | 대응 방안 |
|------|------|------|----------|
| Sprint 1 지연 | 중간 | 높음 | 최소 기능으로 축소 가능 |
| 타입 정의 누락 | 낮음 | 중간 | 점진적 타입 추가 |
| E2E 테스트 환경 이슈 | 중간 | 낮음 | 단위 테스트로 대체 |

### 5.3 축소 계획 (Minimum Viable)

**필수 구현**:
1. claude-proxy Edge Function (단일 응답만)
2. useClaudeGenerate 훅
3. 기본 사용량 로깅

**연기 가능**:
- 스트리밍 응답
- Rate Limiting (API 레벨 의존)
- 채팅 UI
- 캐싱

---

## 6. 배포 전략

### 6.1 환경별 배포

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    배포 파이프라인                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  개발 환경 (Local)                                                       │
│  ═══════════════                                                         │
│  - Supabase Local (supabase start)                                       │
│  - Edge Function 로컬 실행                                                │
│  - ANTHROPIC_API_KEY: 개발용 (저용량)                                    │
│         │                                                                │
│         ▼                                                                │
│  스테이징 환경                                                            │
│  ═════════════                                                           │
│  - Supabase 프로젝트 (staging)                                           │
│  - Edge Function 배포 (supabase functions deploy)                        │
│  - ANTHROPIC_API_KEY: 스테이징용                                         │
│  - Rate Limit: 강화 (테스트용)                                           │
│         │                                                                │
│         ▼                                                                │
│  프로덕션 환경                                                            │
│  ═════════════                                                           │
│  - Supabase 프로젝트 (production)                                        │
│  - Edge Function 배포                                                    │
│  - ANTHROPIC_API_KEY: 프로덕션용                                         │
│  - Rate Limit: 정상                                                      │
│  - 모니터링 활성화                                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 배포 체크리스트

**Sprint 1 배포**:
- [ ] DB 마이그레이션 프로덕션 적용
- [ ] Edge Function 시크릿 설정
- [ ] ANTHROPIC_API_KEY 설정
- [ ] Rate Limit 환경 변수 설정
- [ ] 로그 수집 확인

**Sprint 2 배포**:
- [ ] 프론트엔드 빌드 성공
- [ ] 번들 크기 확인 (증가 최소화)
- [ ] E2E 테스트 통과
- [ ] 스모크 테스트 실행

---

## 7. 성공 기준

### 7.1 기능 요구사항

| ID | 요구사항 | 검증 방법 |
|----|----------|----------|
| FR-01 | 사용자가 텍스트를 입력하면 Claude 응답을 받는다 | E2E 테스트 |
| FR-02 | 대화 컨텍스트가 유지된다 | E2E 테스트 |
| FR-03 | 스트리밍 응답이 점진적으로 표시된다 | 수동 테스트 |
| FR-04 | Rate Limit 초과 시 안내 메시지가 표시된다 | E2E 테스트 |
| FR-05 | 사용량이 기록되고 조회 가능하다 | E2E 테스트 |

### 7.2 비기능 요구사항

| ID | 요구사항 | 목표값 | 검증 방법 |
|----|----------|--------|----------|
| NFR-01 | 응답 시간 | P95 < 10초 | 로그 분석 |
| NFR-02 | 스트리밍 첫 청크 | < 500ms | 수동 측정 |
| NFR-03 | 에러율 | < 1% | 모니터링 |
| NFR-04 | 번들 크기 증가 | < 10KB | 빌드 리포트 |

---

## 8. 후속 작업 (Phase 2)

Sprint 1, 2 완료 후 고려할 확장:

1. **비전 기능**: 이미지 분석 통합
2. **Tool Use**: 외부 API 호출 에이전트
3. **컨텍스트 캐싱**: 긴 시스템 프롬프트 캐싱
4. **Minu 서비스 연동**: RFP 자동 생성, 문서 요약
5. **프롬프트 템플릿 관리**: DB 기반 템플릿 시스템

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0.0 | 2025-11-24 | 초기 작성 | Claude |
