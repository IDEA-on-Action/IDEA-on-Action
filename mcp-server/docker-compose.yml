# =============================================================================
# Compass Navigator MCP Server - Docker Compose 설정
# =============================================================================
# 개발 및 기본 배포용 Docker Compose 설정
# 프로덕션 배포 시 docker-compose.prod.yml과 함께 사용
# =============================================================================

version: "3.9"

# -----------------------------------------------------------------------------
# 서비스 정의
# -----------------------------------------------------------------------------
services:
  mcp-server:
    # 빌드 설정
    build:
      context: .
      dockerfile: Dockerfile

    # 컨테이너 이름
    container_name: compass-mcp-server

    # 포트 매핑 (호스트:컨테이너)
    ports:
      - "3001:3001"

    # 환경 변수 설정
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - HOST=0.0.0.0
      - MCP_TRANSPORT=http

    # 환경 변수 파일 (.env에서 민감한 정보 로드)
    env_file:
      - .env

    # 헬스체크 설정
    # 30초마다 헬스체크, 10초 타임아웃, 5초 시작 대기, 3회 재시도
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:3001/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3

    # 로깅 설정
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # 로그 파일 최대 크기
        max-file: "3"        # 유지할 로그 파일 수
        tag: "{{.Name}}"     # 로그 태그 (컨테이너 이름 사용)

    # 네트워크 연결
    networks:
      - mcp-network

    # 볼륨 마운트 (개발 환경용, 프로덕션에서는 주석 처리)
    # volumes:
    #   - ./src:/app/src:ro
    #   - ./package.json:/app/package.json:ro

# -----------------------------------------------------------------------------
# 네트워크 정의
# -----------------------------------------------------------------------------
networks:
  mcp-network:
    name: compass-mcp-network
    driver: bridge
    # IPv6 지원이 필요한 경우 활성화
    # ipam:
    #   config:
    #     - subnet: 172.28.0.0/16
