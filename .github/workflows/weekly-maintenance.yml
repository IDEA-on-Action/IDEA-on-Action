name: Weekly Maintenance

# ë§¤ì£¼ ì¼ìš”ì¼ 00:00 UTC (ì›”ìš”ì¼ 09:00 KST)
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # ë¬¸ì„œ í¬ê¸° ì²´í¬
  docs-check:
    name: Documentation Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check docs size
        id: check
        run: |
          node scripts/check-docs-size.js
        continue-on-error: true

      - name: Create Issue on Warning
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString().split('T')[0];

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ ë¬¸ì„œ í¬ê¸° ê²½ê³  (${now})`,
              body: `## âš ï¸ ë¬¸ì„œ í¬ê¸°ê°€ ëª©í‘œë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤

            **ì²´í¬ ë‚ ì§œ**: ${now}
            **ìë™í™”**: GitHub Actions (weekly-maintenance.yml)

            ### ê¶Œì¥ ì¡°ì¹˜

            #### CLAUDE.md (ëª©í‘œ: 800 ë¼ì¸ ì´í•˜)
            - ê³¼ê±° ì—…ë°ì´íŠ¸ë¥¼ \`docs/archive/CLAUDE-history-*.md\`ë¡œ ì´ë™
            - ìµœì‹  ì—…ë°ì´íŠ¸ 5ê°œë§Œ ìœ ì§€
            - í•µì‹¬ ì„¹ì…˜(SDD, Constitution, ê¸°ìˆ  ìŠ¤íƒ ë“±)ì€ ìœ ì§€

            #### project-todo.md (ëª©í‘œ: 300 ë¼ì¸ ì´í•˜)
            - ì™„ë£Œëœ ì‘ì—…ì„ ì•„ì¹´ì´ë¸Œë¡œ ì´ë™
            - ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰: \`npm run docs:archive\`
            - ì§„í–‰ ì¤‘/ëŒ€ê¸° ì¤‘ ì‘ì—…ë§Œ ìœ ì§€

            ### ìë™ ì •ë¦¬
            - **ì›”ê°„**: ì™„ë£Œëœ TODO ìë™ ì•„ì¹´ì´ë¸Œ (ë§¤ì›” 1ì¼)
            - **ì£¼ê°„**: ë¬¸ì„œ í¬ê¸° ì²´í¬ (ë§¤ì£¼ ì¼ìš”ì¼)

            ### ì°¸ê³  ë¬¸ì„œ
            - [ë¬¸ì„œ ìœ ì§€ë³´ìˆ˜ ê°€ì´ë“œ](docs/guides/documentation-maintenance.md)
            - [ì•„ì¹´ì´ë¸Œ ì „ëµ](docs/archive/README.md)

            ---
            ğŸ¤– Automated by GitHub Actions`,
              labels: ['documentation', 'maintenance', 'automated']
            });

            console.log(\`Issue created: \${issue.data.html_url}\`);

      - name: Success
        if: steps.check.outcome == 'success'
        run: |
          echo "âœ… ëª¨ë“  ë¬¸ì„œê°€ ëª©í‘œ í¬ê¸° ë‚´ì— ìˆìŠµë‹ˆë‹¤!"

  # Weekly Recap ìƒì„±
  weekly-recap:
    name: Weekly Recap Generation
    runs-on: ubuntu-latest
    needs: docs-check  # ë¬¸ì„œ ì²´í¬ í›„ ì‹¤í–‰
    timeout-minutes: 5

    steps:
      - name: Generate Weekly Recap
        run: |
          response=$(curl -X POST \
            https://zykjdneewbzyazfukzyg.supabase.co/functions/v1/weekly-recap \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --fail-with-body \
            --silent \
            --show-error \
            -w "\nHTTP_CODE:%{http_code}")

          echo "$response"
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d: -f2)

          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Weekly Recap generated successfully"
          else
            echo "âŒ Weekly Recap generation failed (HTTP $http_code)"
            exit 1
          fi

      - name: Log Success
        if: success()
        run: echo "ğŸ“… Weekly Recap completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

      - name: Log Failure
        if: failure()
        run: echo "âš ï¸ Weekly Recap failed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # ì£¼ê°„ ìš”ì•½ ë¦¬í¬íŠ¸
  summary:
    name: Weekly Summary
    runs-on: ubuntu-latest
    needs: [docs-check, weekly-recap]
    if: always()

    steps:
      - name: Create Summary
        uses: actions/github-script@v7
        with:
          script: |
            const docsCheck = '${{ needs.docs-check.result }}';
            const weeklyRecap = '${{ needs.weekly-recap.result }}';

            const summary = `## ğŸ“… Weekly Maintenance Summary

            **Date**: ${new Date().toISOString().split('T')[0]}

            ### Results

            | Task | Status |
            |------|--------|
            | Documentation Size Check | ${docsCheck === 'success' ? 'âœ…' : 'âŒ'} ${docsCheck} |
            | Weekly Recap Generation | ${weeklyRecap === 'success' ? 'âœ…' : 'âŒ'} ${weeklyRecap} |

            ### Next Run
            - **Weekly Maintenance**: Every Sunday 00:00 UTC (Monday 09:00 KST)
            - **Monthly TODO Archive**: 1st of every month
            - **Quarterly Backlog Review**: 1st of Mar/Jun/Sep/Dec

            ---
            ğŸ¤– Automated by GitHub Actions
            `;

            console.log(summary);
