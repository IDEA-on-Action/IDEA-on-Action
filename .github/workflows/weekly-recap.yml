name: Weekly Recap Generation

# ë§¤ì£¼ ì¼ìš”ì¼ 15:00 UTC (ì›”ìš”ì¼ 00:00 KST)
on:
  schedule:
    - cron: '0 15 * * 0'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate-recap:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Weekly Recap
        run: |
          response=$(curl -X POST \
            https://zykjdneewbzyazfukzyg.supabase.co/functions/v1/weekly-recap \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --fail-with-body \
            --silent \
            --show-error \
            -w "\nHTTP_CODE:%{http_code}")

          echo "$response"
          http_code=$(echo "$response" | grep HTTP_CODE | cut -d: -f2)

          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Weekly Recap generated successfully"
          else
            echo "âŒ Weekly Recap generation failed (HTTP $http_code)"
            exit 1
          fi

      - name: Log Success
        if: success()
        run: echo "ğŸ“… Weekly Recap completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

      - name: Log Failure
        if: failure()
        run: echo "âš ï¸ Weekly Recap failed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
